{% extends '../layout/layout.html' %}
{% load static %}
{% load i18n %}

{% block title %}{% trans "Payment History" %}{% endblock %}

{% block extra_css %}
<style>
    .card.payment-card {
        border: 6px solid #10b981 !important;
        border-color: #10b981 !important;
        transition: all 0.2s;
        box-shadow: 0 2px 8px rgba(0,0,0,0.15), 0 0 0 2px #10b981 !important;
        outline: 3px solid #10b981 !important;
    }
    .card.payment-card:hover {
        box-shadow: 0 4px 16px rgba(0,0,0,0.25), 0 0 0 2px #10b981 !important;
    }
    [data-theme="dark"] .card.payment-card {
        border: 6px solid #22c55e !important;
        border-color: #22c55e !important;
        background-color: rgba(255,255,255,0.08);
        box-shadow: 0 4px 12px rgba(34, 197, 94, 0.5), 0 0 0 3px #22c55e !important;
        outline: 4px solid #22c55e !important;
    }
    [data-theme="dark"] .card.payment-card:hover {
        box-shadow: 0 6px 16px rgba(34, 197, 94, 0.6), 0 0 0 3px #22c55e !important;
    }
    .payment-method-badge {
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
    }
    .section-divider {
        border-top: 3px solid rgba(0,0,0,0.2);
        margin: 1rem 0;
    }
    [data-theme="dark"] .section-divider {
        border-top: 5px solid #22c55e;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <div>
                        <h4 class="card-title mb-0">
                            <i class="fas fa-history me-2"></i>
                            {% trans "Payment History" %}
                        </h4>
                        <p class="text-muted small mb-0 mt-1">
                            {% trans "Recent bulk payments (last 100)" %}
                        </p>
                    </div>
                    <div class="d-flex gap-2">
                        <a href="{% url 'orders:payment_history_full' %}" class="btn btn-secondary">
                            <i class="fas fa-list me-2"></i>
                            {% trans "View All" %}
                        </a>
                        <a href="{% url 'orders:bulk_payment_page' %}" class="btn btn-primary">
                            <i class="fas fa-plus-circle me-2"></i>
                            {% trans "New Payment" %}
                        </a>
                    </div>
                </div>
                <div class="card-body">
                    
                    {% if payments %}
                        <div class="row">
                            {% for payment in payments %}
                            <div class="col-md-6 mb-4">
                                <div class="card payment-card">
                                    <div class="card-body">
                                        <!-- Customer Header Section -->
                                        <div class="d-flex justify-content-between align-items-start mb-3">
                                            <div>
                                                <h5 class="mb-1">
                                                    {% if payment.bot_user %}
                                                        {{ payment.bot_user.name }}
                                                        {% if payment.bot_user.is_agency %}
                                                            <span class="badge bg-primary">B2B</span>
                                                        {% else %}
                                                            <span class="badge bg-secondary">B2C</span>
                                                        {% endif %}
                                                    {% else %}
                                                        {% trans "Unknown Customer" %}
                                                    {% endif %}
                                                </h5>
                                                <p class="text-muted small mb-0">
                                                    <i class="fas fa-phone me-1"></i>
                                                    {% if payment.bot_user %}{{ payment.bot_user.phone }}{% else %}N/A{% endif %}
                                                </p>
                                            </div>
                                            <h3 class="text-success mb-0">${{ payment.amount }}</h3>
                                        </div>
                                        
                                        <div class="section-divider"></div>
                                        
                                        <!-- Payment Details -->
                                        <div class="row g-2 mb-3">
                                            <div class="col-6">
                                                <div class="text-muted small">{% trans "Payment Method" %}</div>
                                                <span class="payment-method-badge 
                                                    {% if payment.payment_method == 'cash' %}bg-success{% elif payment.payment_method == 'bank_transfer' %}bg-info{% elif payment.payment_method == 'card' %}bg-primary{% else %}bg-secondary{% endif %} text-white">
                                                    {% if payment.payment_method == 'cash' %}{% trans "Cash" %}
                                                    {% elif payment.payment_method == 'bank_transfer' %}{% trans "Bank Transfer" %}
                                                    {% elif payment.payment_method == 'card' %}{% trans "Card" %}
                                                    {% else %}{% trans "Other" %}{% endif %}
                                                </span>
                                            </div>
                                            <div class="col-6">
                                                <div class="text-muted small">{% trans "Date" %}</div>
                                                <strong>{{ payment.created_at|date:"Y-m-d H:i" }}</strong>
                                            </div>
                                        </div>
                                        
                                        <div class="section-divider"></div>
                                        
                                        <!-- Order Statistics -->
                                        <div class="row g-2 mb-3">
                                            <div class="col-4">
                                                <div class="text-muted small">{% trans "Orders Paid" %}</div>
                                                <strong>{{ payment.orders_count }}</strong>
                                            </div>
                                            <div class="col-4">
                                                <div class="text-muted small">{% trans "Fully Paid" %}</div>
                                                <strong class="text-success">{{ payment.fully_paid_orders }}</strong>
                                            </div>
                                            <div class="col-4">
                                                <div class="text-muted small">{% trans "Remaining" %}</div>
                                                <strong class="text-danger">${{ payment.remaining_debt_after }}</strong>
                                            </div>
                                        </div>
                                        
                                        {% if payment.receipt_note %}
                                        <div class="section-divider"></div>
                                        <div class="alert alert-info mb-3 py-2">
                                            <small><strong>{% trans "Note:" %}</strong> {{ payment.receipt_note }}</small>
                                        </div>
                                        {% endif %}
                                        
                                        <div class="section-divider"></div>
                                        
                                        <!-- Footer Information -->
                                        <div class="d-flex justify-content-between align-items-center">
                                            <small class="text-muted">
                                                <i class="fas fa-user me-1"></i>
                                                {% trans "Processed by" %}: 
                                                {% if payment.processed_by %}
                                                    {{ payment.processed_by.user.get_full_name|default:payment.processed_by.user.username }}
                                                {% else %}
                                                    N/A
                                                {% endif %}
                                            </small>
                                            <small class="text-muted">
                                                {% if payment.branch %}
                                                    <i class="fas fa-map-marker-alt me-1"></i>
                                                    {{ payment.branch.name }}
                                                {% endif %}
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="text-center py-5">
                            <i class="fas fa-receipt text-muted" style="font-size: 64px;"></i>
                            <h5 class="mt-3 text-muted">{% trans "No payment history found" %}</h5>
                            <p class="text-muted">{% trans "Processed bulk payments will appear here" %}</p>
                            <a href="{% url 'orders:bulk_payment_page' %}" class="btn btn-primary mt-2">
                                <i class="fas fa-plus-circle me-2"></i>
                                {% trans "Process First Payment" %}
                            </a>
                        </div>
                    {% endif %}
                    
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

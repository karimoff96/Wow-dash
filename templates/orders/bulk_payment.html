{% extends '../layout/layout.html' %}
{% load static %}
{% load i18n %}

{% block title %}{% trans "Bulk Payment & Top Up" %}{% endblock %}

{% block extra_css %}
<style>
    .customer-search-card {
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        overflow: visible;
    }
    
    .search-input-wrapper {
        position: relative;
        overflow: visible;
    }
    
    #searchResults {
        position: absolute !important;
        z-index: 1050 !important;
        width: 100%;
        max-height: 400px;
        overflow-y: auto;
        background: white;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        border-radius: 8px;
        margin: 0 !important;
        padding: 0 !important;
        top: calc(100% + 4px);
        left: 0;
        right: 0;
        display: block;
    }
    
    #searchResults:empty {
        display: none !important;
    }
    
    #searchResults .list-group {
        border-radius: 8px;
        margin: 0 !important;
        margin-bottom: 0 !important;
    }
    
    #searchResults .list-group-item {
        margin: 0 !important;
        border: 1px solid #dee2e6;
    }
    
    #searchResults .list-group-item:first-child {
        border-top-left-radius: 8px;
        border-top-right-radius: 8px;
    }
    
    #searchResults .list-group-item:last-child {
        border-bottom-left-radius: 8px;
        border-bottom-right-radius: 8px;
    }
    
    .debt-summary-card {
        border-left: 4px solid #ef4444;
        border-radius: 8px;
        background: linear-gradient(135deg, #fef2f2 0%, #ffffff 100%);
    }
    
    .order-debt-card {
        border-left: 3px solid #f59e0b;
        transition: all 0.2s;
    }
    
    .order-debt-card:hover {
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        transform: translateY(-2px);
    }
    
    .payment-input-section {
        background: linear-gradient(135deg, #f0f9ff 0%, #ffffff 100%);
        border-radius: 12px;
        border: 2px solid #3b82f6;
    }
    
    .debt-amount {
        font-size: 2rem;
        font-weight: 700;
        color: #dc2626;
    }
    
    .payment-preview-card {
        background: linear-gradient(135deg, #f0fdf4 0%, #ffffff 100%);
        border-left: 4px solid #10b981;
    }
    
    .debtor-row {
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .debtor-row:hover {
        background-color: #f3f4f6 !important;
        transform: scale(1.01);
    }
    
    .debtor-row.selected {
        background-color: #dbeafe !important;
        border-left: 4px solid #3b82f6;
    }
    
    .debt-badge-high {
        background: #fee2e2;
        color: #991b1b;
        border: 1px solid #fca5a5;
    }
    
    .debt-badge-medium {
        background: #fed7aa;
        color: #9a3412;
        border: 1px solid #fdba74;
    }
    
    .debt-badge-low {
        background: #dcfce7;
        color: #166534;
        border: 1px solid #86efac;
    }
    
    .fifo-order-item {
        border-left: 3px solid #6366f1;
        background: #fafafa;
        transition: all 0.2s;
    }
    
    .fifo-order-item.fully-paid {
        border-left-color: #10b981;
        background: #f0fdf4;
    }
    
    .amount-input {
        font-size: 1.5rem;
        font-weight: 600;
        border: 2px solid #3b82f6;
        border-radius: 8px;
    }
    
    .amount-input:focus {
        border-color: #2563eb;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    
    .pagination .page-link {
        color: #3b82f6;
        border-color: #e5e7eb;
        padding: 0.375rem 0.75rem;
        font-size: 0.875rem;
    }
    
    .pagination.pagination-sm .page-link {
        padding: 0.25rem 0.5rem;
        font-size: 0.8125rem;
    }
    
    .pagination .page-item.active .page-link {
        background-color: #3b82f6;
        border-color: #3b82f6;
        color: white;
        font-weight: 600;
    }
    
    .pagination .page-link:hover:not(.active) {
        background-color: #eff6ff;
        border-color: #3b82f6;
        color: #2563eb;
    }
    
    .pagination .page-item.disabled .page-link {
        color: #9ca3af;
        background-color: #f9fafb;
        border-color: #e5e7eb;
    }
    
    .pagination .page-link:focus {
        box-shadow: 0 0 0 0.2rem rgba(59, 130, 246, 0.25);
        z-index: 3;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Page Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h4 class="mb-1">
                        <i class="fas fa-money-bill-wave text-success me-2"></i>
                        {% trans "Bulk Payment & Top Up" %}
                    </h4>
                    <p class="text-muted mb-0">
                        {% trans "Process payments for agencies and customers with outstanding debts" %}
                    </p>
                </div>
                <div>
                    <a href="{% url 'orders:payment_history' %}" class="btn btn-outline-primary">
                        <i class="fas fa-history me-2"></i>
                        {% trans "Payment History" %}
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Summary Statistics Cards -->
    <div class="row mb-4" id="summaryStatistics">
        <div class="col-md-3">
            <div class="card border-start border-danger border-4">
                <div class="card-body">
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <p class="text-muted mb-1 text-sm">{% trans "Total Debt" %}</p>
                            <h4 class="mb-0 text-danger fw-bold">
                                {% load number_filters %}
                                {{ total_debt_amount|format_number }} {% trans "UZS" %}
                            </h4>
                        </div>
                        <div class="avatar-sm bg-danger bg-opacity-10 rounded-3">
                            <iconify-icon icon="solar:wallet-money-bold" class="text-danger fs-2"></iconify-icon>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card border-start border-warning border-4">
                <div class="card-body">
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <p class="text-muted mb-1 text-sm">{% trans "Total Debtors" %}</p>
                            <h4 class="mb-0 text-warning fw-bold">{{ total_debtors }}</h4>
                            <small class="text-muted">{% trans "customers" %}</small>
                        </div>
                        <div class="avatar-sm bg-warning bg-opacity-10 rounded-3">
                            <iconify-icon icon="solar:users-group-rounded-bold" class="text-warning fs-2"></iconify-icon>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card border-start border-info border-4">
                <div class="card-body">
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <p class="text-muted mb-1 text-sm">{% trans "Outstanding Orders" %}</p>
                            <h4 class="mb-0 text-info fw-bold">{{ total_orders_with_debt }}</h4>
                            <small class="text-muted">{% trans "orders" %}</small>
                        </div>
                        <div class="avatar-sm bg-info bg-opacity-10 rounded-3">
                            <iconify-icon icon="solar:file-text-bold" class="text-info fs-2"></iconify-icon>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card border-start border-primary border-4">
                <div class="card-body">
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <p class="text-muted mb-1 text-sm">{% trans "Average Debt" %}</p>
                            <h4 class="mb-0 text-primary fw-bold">
                                {{ avg_debt_per_customer|floatformat:0|format_number }} {% trans "UZS" %}
                            </h4>
                        </div>
                        <div class="avatar-sm bg-primary bg-opacity-10 rounded-3">
                            <iconify-icon icon="solar:chart-bold" class="text-primary fs-2"></iconify-icon>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Top 10 Debtors Widget -->
    {% if top_10_debtors %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-light d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">
                        <iconify-icon icon="solar:medal-star-bold" class="text-warning me-2"></iconify-icon>
                        {% trans "Top 10 Debtors" %}
                    </h6>
                    <small class="text-muted">{% trans "Click to select for payment" %}</small>
                </div>
                <div class="card-body p-24">
                    <div class="table-responsive">
                        <table class="table bordered-table sm-table mb-0">
                            <thead>
                                <tr>
                                    <th scope="col" style="width: 40px;">#</th>
                                    <th scope="col">{% trans "Customer" %}</th>
                                    <th scope="col">{% trans "Type" %}</th>
                                    <th scope="col" class="text-end">{% trans "Total Debt" %}</th>
                                    <th scope="col" class="text-center">{% trans "Orders" %}</th>
                                    <th scope="col" class="text-center">{% trans "Action" %}</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for debtor in top_10_debtors %}
                                <tr class="debtor-row" style="cursor: pointer;" data-customer-id="{{ debtor.customer_id }}">
                                    <td class="text-muted">{{ forloop.counter }}</td>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div class="avatar-xs bg-primary bg-opacity-10 rounded-circle me-2 d-flex align-items-center justify-content-center">
                                                <iconify-icon icon="solar:user-bold" class="text-primary"></iconify-icon>
                                            </div>
                                            <div>
                                                <div class="fw-semibold">{{ debtor.name }}</div>
                                                <small class="text-muted">{{ debtor.phone|default:"-" }}</small>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        {% if debtor.customer_type == 'agency' %}
                                        <span class="badge bg-primary-subtle text-primary">
                                            <iconify-icon icon="solar:buildings-2-bold" class="me-1"></iconify-icon>
                                            {% trans "Agency" %}
                                        </span>
                                        {% else %}
                                        <span class="badge bg-success-subtle text-success">
                                            <iconify-icon icon="solar:user-bold" class="me-1"></iconify-icon>
                                            {% trans "Individual" %}
                                        </span>
                                        {% endif %}
                                    </td>
                                    <td class="text-end">
                                        <span class="fw-bold text-danger">{{ debtor.total_debt|floatformat:0|format_number }} {% trans "UZS" %}</span>
                                    </td>
                                    <td class="text-center">
                                        <span class="badge bg-info">{{ debtor.order_count }}</span>
                                    </td>
                                    <td class="text-center">
                                        <button class="btn btn-sm btn-primary select-debtor-btn" data-customer-id="{{ debtor.customer_id }}">
                                            <iconify-icon icon="solar:check-circle-bold" class="me-1"></iconify-icon>
                                            {% trans "Select" %}
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="card-footer bg-light text-center">
                    <a href="{% url 'debtors_report' %}" class="text-decoration-none">
                        {% trans "View All Debtors" %} →
                    </a>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Quick Customer Search (Only shown when no customer selected) -->
    <div class="row mb-4" id="customerSearchSection">
        <div class="col-12">
            <div class="card customer-search-card">
                <div class="card-body">
                    <h6 class="mb-3">
                        <iconify-icon icon="solar:user-search-bold" class="me-2"></iconify-icon>
                        {% trans "Search Customer" %}
                    </h6>
                    <div class="row align-items-end">
                        <div class="col-md-8">
                            <div class="search-input-wrapper">
                                <div class="input-group">
                                    <span class="input-group-text">
                                        <iconify-icon icon="solar:magnifer-bold"></iconify-icon>
                                    </span>
                                    <input type="text" 
                                           id="customerSearch" 
                                           class="form-control" 
                                           placeholder="{% trans 'Search by name or phone number...' %}"
                                           autocomplete="off">
                                </div>
                                <div id="searchResults"></div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <a href="{% url 'debtors_report' %}" class="btn btn-outline-primary w-100">
                                <iconify-icon icon="solar:users-group-rounded-bold" class="me-2"></iconify-icon>
                                {% trans "View All Debtors" %}
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Payment Section Message -->
    <div class="row mb-4" id="noCustomerMessage">
        <div class="col-12">
            <div class="alert alert-info d-flex align-items-center">
                <iconify-icon icon="solar:info-circle-bold" class="text-xl me-3"></iconify-icon>
                <div>
                    <strong>{% trans "No customer selected" %}</strong><br>
                    <small>{% trans "Search for a customer above or select from the" %} <a href="{% url 'debtors_report' %}">{% trans "debtors report" %}</a> {% trans "to process a payment" %}</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Selected Customer & Payment Section (Initially Hidden) -->
    <div id="paymentSection" style="display: none;">
        
        <!-- Change Customer Button -->
        <div class="row mb-3">
            <div class="col-12">
                <button type="button" id="changeCustomerBtn" class="btn btn-outline-secondary btn-sm">
                    <iconify-icon icon="solar:arrow-left-bold" class="me-1"></iconify-icon>
                    {% trans "Change Customer" %}
                </button>
            </div>
        </div>
        
        <!-- Customer Debt Summary -->
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="card debt-summary-card">
                    <div class="card-body">
                        <h6 class="text-muted mb-2">
                            <i class="fas fa-user-circle me-2"></i>
                            {% trans "Customer" %}
                        </h6>
                        <h5 id="selectedCustomerName" class="mb-1">-</h5>
                        <p id="selectedCustomerPhone" class="text-muted mb-0">-</p>
                        <span id="selectedCustomerType" class="badge mt-2">-</span>
                    </div>
                </div>
            </div>
            
            <div class="col-md-4">
                <div class="card debt-summary-card">
                    <div class="card-body">
                        <h6 class="text-muted mb-2">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            {% trans "Total Outstanding Debt" %}
                        </h6>
                        <div class="debt-amount" id="totalDebtAmount">$0.00</div>
                        <p class="text-muted mb-0">
                            <span id="debtOrderCount">0</span> {% trans "orders" %}
                        </p>
                    </div>
                </div>
            </div>
            
            <div class="col-md-4">
                <div class="card debt-summary-card">
                    <div class="card-body">
                        <h6 class="text-muted mb-2">
                            <i class="fas fa-clock me-2"></i>
                            {% trans "Oldest Debt" %}
                        </h6>
                        <h4 id="oldestDebtDays">-</h4>
                        <p class="text-muted mb-0">{% trans "days old" %}</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Payment Form and Orders Side-by-Side -->
        <div class="row mb-4">
            <!-- Payment Input Section -->
            <div class="col-md-5">
                <div class="card payment-input-section">
                    <div class="card-body">
                        <h5 class="mb-4">
                            <i class="fas fa-hand-holding-usd me-2"></i>
                            {% trans "Process Payment" %}
                        </h5>
                        
                        <form id="paymentForm">
                            {% csrf_token %}
                            <input type="hidden" id="selectedCustomerId" name="customer_id">
                            
                            <div class="mb-3">
                                <label for="paymentAmount" class="form-label fw-bold">
                                    {% trans "Payment Amount" %}
                                </label>
                                <div class="input-group input-group-lg">
                                    <span class="input-group-text">$</span>
                                    <input type="number" 
                                           class="form-control amount-input" 
                                           id="paymentAmount" 
                                           name="payment_amount"
                                           step="0.01" 
                                           min="0.01" 
                                           placeholder="0.00"
                                           required>
                                </div>
                                <small class="text-muted">
                                    <i class="fas fa-info-circle me-1"></i>
                                    {% trans "Payment will be distributed to orders using FIFO (First In, First Out)" %}
                                </small>
                            </div>
                            
                            <div class="mb-3">
                                <label for="paymentMethod" class="form-label fw-bold">
                                    {% trans "Payment Method" %}
                                </label>
                                <select class="form-select" id="paymentMethod" name="payment_method" required>
                                    <option value="cash">{% trans "Cash" %}</option>
                                    <option value="bank_transfer">{% trans "Bank Transfer" %}</option>
                                    <option value="card">{% trans "Card Payment" %}</option>
                                    <option value="other">{% trans "Other" %}</option>
                                </select>
                            </div>
                            
                            <div class="mb-4">
                                <label for="receiptNote" class="form-label">
                                    {% trans "Receipt/Note" %} <small class="text-muted">({% trans "optional" %})</small>
                                </label>
                                <textarea class="form-control" 
                                          id="receiptNote" 
                                          name="receipt_note"
                                          rows="3" 
                                          placeholder="{% trans 'Transaction ID, receipt number, or notes...' %}"></textarea>
                            </div>
                            
                            <div class="d-grid gap-2">
                                <button type="button" 
                                        id="previewPaymentBtn" 
                                        class="btn btn-info btn-lg">
                                    <i class="fas fa-eye me-2"></i>
                                    {% trans "Preview Distribution" %}
                                </button>
                                <button type="submit" 
                                        id="processPaymentBtn" 
                                        class="btn btn-success btn-lg"
                                        style="display: none;">
                                    <i class="fas fa-check-circle me-2"></i>
                                    {% trans "Process Payment" %}
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            
            <!-- Outstanding Orders List -->
            <div class="col-md-7">
                <div class="card" style="max-height: 600px; overflow-y: auto;">
                    <div class="card-header bg-light sticky-top">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-0">
                                    <iconify-icon icon="solar:file-text-bold" class="me-2"></iconify-icon>
                                    {% trans "Outstanding Orders" %}
                                </h6>
                                <small class="text-muted">{% trans "Orders will be paid in FIFO order (oldest first)" %}</small>
                            </div>
                            <span class="badge bg-primary" id="ordersCount">0</span>
                        </div>
                    </div>
                    <div class="card-body p-2">
                        <div id="outstandingOrdersList">
                            <!-- Orders populated via JavaScript -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Payment Preview (Full Width Below) -->
        <div class="row mb-4">
            <div class="col-12">
                <div id="paymentPreviewCard" class="card payment-preview-card" style="display: none;">
                    <div class="card-header bg-success text-white">
                        <h6 class="mb-0">
                            <iconify-icon icon="solar:chart-bold" class="me-2"></iconify-icon>
                            {% trans "Payment Distribution Preview" %}
                        </h6>
                    </div>
                    <div class="card-body">
                        <div id="paymentPreviewContent">
                            <!-- Preview content populated via JavaScript -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Success Modal -->
<div class="modal fade" id="successModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">
                    <i class="fas fa-check-circle me-2"></i>
                    {% trans "Payment Successful" %}
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center py-4">
                <div class="mb-3">
                    <i class="fas fa-check-circle text-success" style="font-size: 4rem;"></i>
                </div>
                <h4 class="mb-3">{% trans "Payment Processed Successfully!" %}</h4>
                <div id="successModalContent">
                    <!-- Success details populated via JavaScript -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    {% trans "Close" %}
                </button>
                <button type="button" class="btn btn-primary" onclick="window.location.reload()">
                    <i class="fas fa-plus me-2"></i>
                    {% trans "Process Another Payment" %}
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block script %}
<script>
(function() {
    'use strict';
    
    // Translation strings for JavaScript
    const translations = {
        paidBy: "{% trans 'Paid by' %}",
        order: "{% trans 'Order' %}",
        days: "{% trans 'days' %}",
        total: "{% trans 'Total' %}",
        paid: "{% trans 'Paid' %}",
        remaining: "{% trans 'Remaining' %}",
        uzs: "{% trans 'UZS' %}"
    };

    let selectedCustomerId = null;
    let customerDebtData = null;
    let paymentPreviewData = null;

    document.addEventListener('DOMContentLoaded', function() {
        console.log('Document ready - initializing');
        
        const customerSearchInput = document.getElementById('customerSearch');
        const searchResults = document.getElementById('searchResults');
        
        console.log('Search input exists:', customerSearchInput !== null);
        
        // Hide customer search section and show no customer message initially
        document.getElementById('customerSearchSection').style.display = 'block';
        document.getElementById('noCustomerMessage').style.display = 'block';
        document.getElementById('paymentSection').style.display = 'none';
        
        // Auto-select customer if coming from debtors report
        {% if preselected_customer_id %}
        const preselectedCustomerId = '{{ preselected_customer_id }}';
        if (preselectedCustomerId) {
            console.log('Auto-selecting customer:', preselectedCustomerId);
            document.getElementById('customerSearchSection').style.display = 'none';
            document.getElementById('noCustomerMessage').style.display = 'none';
            document.getElementById('summaryStatistics').style.display = 'none';
            setTimeout(function() {
                selectCustomer(parseInt(preselectedCustomerId));
            }, 500);
        }
        {% endif %}
        
        // Handle clicks on top debtors table
        const selectDebtorBtns = document.querySelectorAll('.select-debtor-btn');
        selectDebtorBtns.forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.stopPropagation();
                const customerId = this.getAttribute('data-customer-id');
                console.log('Selecting debtor from top 10:', customerId);
                document.getElementById('customerSearchSection').style.display = 'none';
                document.getElementById('noCustomerMessage').style.display = 'none';
                document.getElementById('summaryStatistics').style.display = 'none';
                selectCustomer(customerId);
                // Scroll to payment section
                setTimeout(() => {
                    const paymentSection = document.getElementById('paymentSection');
                    window.scrollTo({
                        top: paymentSection.offsetTop - 100,
                        behavior: 'smooth'
                    });
                }, 300);
            });
        });
        
        // Handle clicks on debtor row (anywhere except button)
        const debtorRows = document.querySelectorAll('.debtor-row');
        debtorRows.forEach(row => {
            row.addEventListener('click', function(e) {
                if (!e.target.classList.contains('select-debtor-btn')) {
                    this.querySelector('.select-debtor-btn').click();
                }
            });
        });
        
        // Customer search with debounce
        let searchTimeout;
        
        function performSearch() {
            const query = customerSearchInput.value.trim();
            console.log('Performing search with query:', query);
            
            if (query.length < 2) {
                console.log('Query too short, clearing results');
                searchResults.innerHTML = '';
                return;
            }
            
            searchCustomers(query);
        }
        
        customerSearchInput.addEventListener('input', function() {
            console.log('Input event fired, value:', this.value);
            clearTimeout(searchTimeout);
            const query = this.value.trim();
            
            if (query.length < 2) {
                console.log('Query too short, clearing results');
                searchResults.innerHTML = '';
                return;
            }
            
            console.log('Setting timeout for search');
            searchTimeout = setTimeout(() => {
                console.log('Timeout fired, calling searchCustomers');
                searchCustomers(query);
            }, 300);
        });
        
        // Enter key to search
        customerSearchInput.addEventListener('keypress', function(e) {
            if (e.which === 13 || e.keyCode === 13) {
                e.preventDefault();
                console.log('Enter key pressed');
                performSearch();
            }
        });

        // Preview payment button
        const previewBtn = document.getElementById('previewPaymentBtn');
        if (previewBtn) {
            previewBtn.addEventListener('click', function() {
                previewPayment();
            });
        }

        // Process payment form submission
        const paymentForm = document.getElementById('paymentForm');
        if (paymentForm) {
            paymentForm.addEventListener('submit', function(e) {
                e.preventDefault();
                processPayment();
            });
        }
        
        // Change customer button
        const changeCustomerBtn = document.getElementById('changeCustomerBtn');
        if (changeCustomerBtn) {
            changeCustomerBtn.addEventListener('click', function() {
                document.getElementById('paymentSection').style.display = 'none';
                document.getElementById('customerSearchSection').style.display = 'block';
                document.getElementById('noCustomerMessage').style.display = 'block';
                document.getElementById('summaryStatistics').style.display = 'block';
                customerSearchInput.value = '';
                customerSearchInput.focus();
                searchResults.innerHTML = '';
                selectedCustomerId = null;
                customerDebtData = null;
                paymentPreviewData = null;
                // Scroll to top
                window.scrollTo({ top: 0, behavior: 'smooth' });
            });
        }
    });

    function searchCustomers(query) {
        console.log('Searching customers with query:', query);
        const url = '{% url "orders:search_customers_with_debt" %}?q=' + encodeURIComponent(query);
        console.log('Fetching URL:', url);
        
        fetch(url)
            .then(response => {
                console.log('Response status:', response.status);
                console.log('Response ok:', response.ok);
                if (!response.ok) {
                    throw new Error('HTTP error! status: ' + response.status);
                }
                return response.json();
            })
            .then(data => {
                console.log('Search successful:', data);
                console.log('Number of customers:', data.customers ? data.customers.length : 0);
                displaySearchResults(data.customers);
            })
            .catch(error => {
                console.error('Search error:', error);
                showError('{% trans "Failed to search customers" %}');
            });
    }

    function displaySearchResults(customers) {
        console.log('displaySearchResults called with:', customers);
        const searchResults = document.getElementById('searchResults');
        console.log('searchResults element:', searchResults);
        
        if (!searchResults) {
            console.error('searchResults element not found!');
            return;
        }
        
        searchResults.innerHTML = '';
        
        if (!customers || customers.length === 0) {
            searchResults.innerHTML = '<p class="text-muted small m-2">{% trans "No customers found" %}</p>';
            return;
        }
        
        const listGroup = document.createElement('div');
        listGroup.className = 'list-group';
        listGroup.style.margin = '0';
        
        customers.forEach(customer => {
            const typeClass = customer.is_agency ? 'primary' : 'info';
            const typeIcon = customer.is_agency ? 'building' : 'user';
            
            const item = document.createElement('a');
            item.href = '#';
            item.className = 'list-group-item list-group-item-action search-result-item';
            item.setAttribute('data-customer-id', customer.id);
            item.innerHTML = `
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <strong>${customer.name}</strong>
                        <br>
                        <small class="text-muted">
                            <i class="fas fa-phone me-1"></i>${customer.phone}
                        </small>
                        <span class="badge bg-${typeClass} ms-2">
                            <i class="fas fa-${typeIcon} me-1"></i>${customer.customer_type}
                        </span>
                    </div>
                    <div class="text-end">
                        <strong class="text-danger">$${customer.total_debt.toFixed(2)}</strong>
                        <br>
                        <small class="text-muted">${customer.order_count} {% trans "orders" %}</small>
                    </div>
                </div>
            `;
            
            item.addEventListener('click', function(e) {
                e.preventDefault();
                selectCustomer(customer.id);
                searchResults.innerHTML = '';
                document.getElementById('customerSearch').value = '';
            });
            
            listGroup.appendChild(item);
        });
        
        searchResults.appendChild(listGroup);
    }

    function selectCustomer(customerId) {
        selectedCustomerId = customerId;
        
        // Highlight selected row in table
        document.querySelectorAll('.debtor-row').forEach(row => row.classList.remove('selected'));
        const selectedRow = document.querySelector(`.debtor-row[data-customer-id="${customerId}"]`);
        if (selectedRow) {
            selectedRow.classList.add('selected');
        }
        
        // Scroll to payment section
        const paymentSection = document.getElementById('paymentSection');
        window.scrollTo({
            top: paymentSection.offsetTop - 100,
            behavior: 'smooth'
        });
        
        // Load customer debt details
        loadCustomerDebt(customerId);
    }

    function loadCustomerDebt(customerId) {
        const url = '{% url "orders:get_customer_debt_details" 0 %}'.replace('/0/', `/${customerId}/`);
        fetch(url)
            .then(response => response.json())
            .then(data => {
                customerDebtData = data;
                displayCustomerDebt(data);
                // Hide search section and show payment section
                document.getElementById('customerSearchSection').style.display = 'none';
                document.getElementById('noCustomerMessage').style.display = 'none';
                document.getElementById('paymentSection').style.display = 'block';
                // Scroll to payment section
                window.scrollTo({
                    top: document.getElementById('paymentSection').offsetTop - 100,
                    behavior: 'smooth'
                });
            })
            .catch(error => {
                console.error('Error loading customer debt:', error);
                showError('{% trans "Failed to load customer debt details" %}');
            });
    }

    function displayCustomerDebt(data) {
        // Update customer info
        document.getElementById('selectedCustomerId').value = data.customer.id;
        document.getElementById('selectedCustomerName').textContent = data.customer.name;
        document.getElementById('selectedCustomerPhone').textContent = data.customer.phone;
        
        const typeClass = data.customer.is_agency ? 'primary' : 'info';
        const selectedCustomerType = document.getElementById('selectedCustomerType');
        selectedCustomerType.className = 'badge mt-2 bg-' + typeClass;
        selectedCustomerType.innerHTML = `<i class="fas fa-${data.customer.is_agency ? 'building' : 'user'} me-1"></i>${data.customer.customer_type}`;
        
        // Update debt summary
        document.getElementById('totalDebtAmount').textContent = '$' + data.debt_summary.total_debt.toFixed(2);
        document.getElementById('debtOrderCount').textContent = data.debt_summary.order_count;
        document.getElementById('oldestDebtDays').textContent = data.debt_summary.oldest_debt_days || '-';
        document.getElementById('ordersCount').textContent = data.debt_summary.order_count;
        
        // Display orders in compact format
        const ordersList = document.getElementById('outstandingOrdersList');
        ordersList.innerHTML = '';
        
        data.orders.forEach((order, index) => {
            // Build payment info badge if available
            let paymentInfoHtml = '';
            if (order.payment_info) {
                paymentInfoHtml = `
                    <div class="small text-success mt-1">
                        <iconify-icon icon="solar:user-check-bold-duotone" style="font-size: 12px;"></iconify-icon>
                        <strong>${translations.paidBy}:</strong> ${order.payment_info.received_by}
                        <br>
                        <iconify-icon icon="solar:calendar-check-bold-duotone" style="font-size: 12px;"></iconify-icon>
                        ${order.payment_info.received_at}
                    </div>
                `;
            }
            
            const orderHtml = `
                <div class="card mb-2 order-debt-card">
                    <div class="card-body p-2">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <div class="d-flex align-items-center mb-1">
                                    <span class="badge bg-secondary me-2">#${index + 1}</span>
                                    <strong class="small">${translations.order} #${order.order_number}</strong>
                                    <span class="badge bg-warning ms-2 small">${order.status}</span>
                                </div>
                                <div class="small text-muted mb-1">
                                    <iconify-icon icon="solar:calendar-bold-duotone" style="font-size: 12px;"></iconify-icon> ${order.created_at}
                                    <span class="ms-2">
                                        <iconify-icon icon="solar:clock-circle-bold-duotone" style="font-size: 12px;"></iconify-icon> ${order.days_old} ${translations.days}
                                    </span>
                                </div>
                                <div class="small">
                                    <strong>${order.product}</strong> • ${order.branch}
                                </div>
                                ${paymentInfoHtml}
                            </div>
                            <div class="text-end ms-2">
                                <div class="small text-muted">${translations.total}: ${order.total_price.toFixed(2)} ${translations.uzs}</div>
                                <div class="small text-muted">${translations.paid}: ${order.received.toFixed(2)} ${translations.uzs}</div>
                                <div class="badge bg-danger mt-1">
                                    <strong>${order.remaining.toFixed(2)} ${translations.uzs}</strong>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            ordersList.insertAdjacentHTML('beforeend', orderHtml);
        });
    }

    function previewPayment() {
        const amount = parseFloat(document.getElementById('paymentAmount').value);
        
        if (!amount || amount <= 0) {
            showError('{% trans "Please enter a valid payment amount" %}');
            return;
        }
        
        if (!selectedCustomerId) {
            showError('{% trans "Please select a customer" %}');
            return;
        }
        
        const formData = new FormData();
        formData.append('customer_id', selectedCustomerId);
        formData.append('payment_amount', amount);
        formData.append('csrfmiddlewaretoken', document.querySelector('input[name=csrfmiddlewaretoken]').value);
        
        fetch('{% url "orders:preview_payment_distribution" %}', {
            method: 'POST',
            body: formData
        })
            .then(response => response.json())
            .then(data => {
                paymentPreviewData = data;
                displayPaymentPreview(data);
            })
            .catch(error => {
                console.error('Error previewing payment:', error);
                showError('{% trans "Failed to preview payment" %}');
            });
    }

    function displayPaymentPreview(data) {
        const preview = document.getElementById('paymentPreviewContent');
        preview.innerHTML = '';
        
        // Summary
        let summaryHtml = `
            <div class="alert alert-info">
                <h6><i class="fas fa-info-circle me-2"></i>{% trans "Payment Summary" %}</h6>
                <ul class="mb-0">
                    <li><strong>{% trans "Payment Amount" %}:</strong> $${data.summary.payment_amount.toFixed(2)}</li>
                    <li><strong>{% trans "Orders Affected" %}:</strong> ${data.summary.orders_affected}</li>
                    <li><strong>{% trans "Fully Paid Orders" %}:</strong> ${data.summary.fully_paid_orders}</li>
                    <li><strong>{% trans "Remaining Debt After" %}:</strong> $${data.summary.remaining_debt_after.toFixed(2)}</li>
                    ${data.summary.unused_amount > 0 ? `<li class="text-warning"><strong>{% trans "Unused Amount" %}:</strong> $${data.summary.unused_amount.toFixed(2)}</li>` : ''}
                </ul>
            </div>
        `;
        
        // Distribution details
        let distributionHtml = '<h6 class="mt-3"><i class="fas fa-list me-2"></i>{% trans "FIFO Distribution" %}</h6>';
        
        data.distribution.forEach((item, index) => {
            const fullyPaidClass = item.fully_paid ? 'fully-paid' : '';
            const fullyPaidBadge = item.fully_paid ? '<span class="badge bg-success ms-2">{% trans "Fully Paid" %}</span>' : '';
            
            distributionHtml += `
                <div class="fifo-order-item ${fullyPaidClass} p-3 mb-2 rounded">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <strong>${index + 1}. {% trans "Order" %} #${item.order_number}</strong>
                            ${fullyPaidBadge}
                            <br>
                            <small class="text-muted">
                                {% trans "Current Remaining" %}: $${item.current_remaining.toFixed(2)}
                            </small>
                        </div>
                        <div class="text-end">
                            <strong class="text-success">-$${item.amount_applied.toFixed(2)}</strong>
                            <br>
                            <small class="text-muted">
                                {% trans "New Remaining" %}: $${item.new_remaining.toFixed(2)}
                            </small>
                        </div>
                    </div>
                </div>
            `;
        });
        
        preview.innerHTML = summaryHtml + distributionHtml;
        
        const paymentPreviewCard = document.getElementById('paymentPreviewCard');
        const processPaymentBtn = document.getElementById('processPaymentBtn');
        paymentPreviewCard.style.display = 'block';
        processPaymentBtn.style.display = 'block';
        
        // Scroll to preview
        window.scrollTo({
            top: paymentPreviewCard.offsetTop - 100,
            behavior: 'smooth'
        });
    }

    function processPayment() {
        if (!paymentPreviewData) {
            showError('{% trans "Please preview the payment first" %}');
            return;
        }
        
        const btn = document.getElementById('processPaymentBtn');
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>{% trans "Processing..." %}';
        
        const paymentForm = document.getElementById('paymentForm');
        const formData = new FormData(paymentForm);
        
        fetch('{% url "orders:process_bulk_payment" %}', {
            method: 'POST',
            body: formData
        })
            .then(response => response.json())
            .then(data => {
                displaySuccessModal(data);
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-check-circle me-2"></i>{% trans "Process Payment" %}';
            })
            .catch(error => {
                console.error('Error processing payment:', error);
                showError('{% trans "Failed to process payment" %}');
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-check-circle me-2"></i>{% trans "Process Payment" %}';
            });
    }

    function displaySuccessModal(response) {
        const content = `
            <div class="row">
                <div class="col-6">
                    <p class="mb-1"><strong>{% trans "Payment Amount" %}</strong></p>
                    <h4 class="text-success">$${response.summary.payment_amount.toFixed(2)}</h4>
                </div>
                <div class="col-6">
                    <p class="mb-1"><strong>{% trans "Orders Paid" %}</strong></p>
                    <h4 class="text-primary">${response.summary.orders_paid}</h4>
                </div>
            </div>
            <hr>
            <div class="row">
                <div class="col-6">
                    <p class="mb-1"><strong>{% trans "Fully Paid" %}</strong></p>
                    <h5 class="text-success">${response.summary.fully_paid_orders}</h5>
                </div>
                <div class="col-6">
                    <p class="mb-1"><strong>{% trans "Remaining Debt" %}</strong></p>
                    <h5 class="text-danger">$${response.summary.remaining_debt.toFixed(2)}</h5>
                </div>
            </div>
        `;
        
        document.getElementById('successModalContent').innerHTML = content;
        const modal = new bootstrap.Modal(document.getElementById('successModal'));
        modal.show();
    }

    function showError(message) {
        // You can use your existing toast/alert system
        alert(message);
    }
})();
</script>
{% endblock %}

{% extends '../layout/layout.html' %}
{% load static %}

{% block content %}
<!-- Select2 CSS -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<style>
    /* Select2 styling to exactly match native .form-select elements */
    .select2-container {
        width: 100% !important;
        margin: 0 !important;
        padding: 0 !important;
        display: block !important;
        box-sizing: border-box !important;
    }
    
    /* Ensure the container spans full width */
    .select2-container--default {
        width: 100% !important;
    }
    
    /* Ensure all nested wrappers are full width */
    .select2-container .selection,
    .select2-container .select2-selection {
        width: 100% !important;
        display: block !important;
        box-sizing: border-box !important;
    }
    
    /* Main select box - match .form-select exactly */
    .select2-container .select2-selection--single {
        height: 46px !important;
        padding: 0 !important;
        margin: 0 !important;
        font-size: 14px !important;
        line-height: 1.5 !important;
        color: inherit !important;
        background-color: transparent !important;
        background-clip: padding-box !important;
        border: 1px solid var(--border-neutral-300, #d5d5d5) !important;
        border-radius: 8px !important;
        transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out !important;
        box-shadow: none !important;
        display: block !important;
    }
    
    /* Selected text styling */
    .select2-container--default .select2-selection--single .select2-selection__rendered {
        display: block !important;
        padding-left: 16px !important;
        padding-right: 40px !important;
        overflow: hidden !important;
        text-overflow: ellipsis !important;
        white-space: nowrap !important;
        line-height: 44px !important;
        font-size: 14px !important;
        color: var(--text-primary, inherit) !important;
        margin: 0 !important;
    }
    
    /* Placeholder text */
    .select2-container--default .select2-selection--single .select2-selection__placeholder {
        color: var(--text-tertiary, #9ca3af) !important;
        opacity: 0.7 !important;
    }
    
    /* Dropdown arrow */
    .select2-container--default .select2-selection--single .select2-selection__arrow {
        height: 46px !important;
        position: absolute !important;
        top: 0 !important;
        right: 10px !important;
        width: 20px !important;
    }
    
    .select2-container--default .select2-selection--single .select2-selection__arrow b {
        border-color: var(--text-secondary, #6c757d) transparent transparent transparent !important;
        border-style: solid !important;
        border-width: 5px 4px 0 4px !important;
        height: 0 !important;
        left: 50% !important;
        margin-left: -4px !important;
        margin-top: -2px !important;
        position: absolute !important;
        top: 50% !important;
        width: 0 !important;
    }
    
    /* Focus and open states */
    .select2-container--default.select2-container--focus .select2-selection--single,
    .select2-container--default.select2-container--open .select2-selection--single {
        border-color: #487fff !important;
        outline: 0 !important;
        box-shadow: 0 0 0 0.2rem rgba(72, 127, 255, 0.15) !important;
    }
    
    /* Disabled state */
    .select2-container--default.select2-container--disabled .select2-selection--single {
        background-color: var(--bg-neutral-100, #f5f5f5) !important;
        cursor: not-allowed !important;
        opacity: 0.6 !important;
    }
    
    /* Dropdown container - solid background */
    .select2-dropdown {
        background-color: #2e3650 !important;
        border: 1px solid var(--border-neutral-300, #d5d5d5) !important;
        border-radius: 8px !important;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06) !important;
        margin-top: 4px !important;
        z-index: 9999 !important;
    }
    
    /* Dropdown results container */
    .select2-results {
        background-color: #2e3650 !important;
    }
    
    /* Dropdown options */
    .select2-container--default .select2-results__option {
        padding: 10px 16px !important;
        font-size: 14px !important;
        color: inherit !important;
        background-color: #2e3650 !important;
        cursor: pointer !important;
    }
    
    /* Highlighted option */
    .select2-container--default .select2-results__option--highlighted[aria-selected] {
        background-color: #487fff !important;
        color: #ffffff !important;
    }
    
    /* Selected option */
    .select2-container--default .select2-results__option[aria-selected=true] {
        background-color: var(--bg-neutral-100, rgba(0, 0, 0, 0.05)) !important;
        color: var(--text-primary, inherit) !important;
    }
    
    /* Search box in dropdown */
    .select2-search--dropdown {
        padding: 8px !important;
        background-color: #2e3650 !important;
    }
    
    .select2-search--dropdown .select2-search__field {
        padding: 8px 12px !important;
        width: 100% !important;
        box-sizing: border-box !important;
        border: 1px solid var(--border-neutral-300, #d5d5d5) !important;
        border-radius: 6px !important;
        background-color: #3d4563 !important;
        color: inherit !important;
        font-size: 14px !important;
    }
    
    .select2-search--dropdown .select2-search__field:focus {
        border-color: #487fff !important;
        outline: 0 !important;
        box-shadow: 0 0 0 0.15rem rgba(72, 127, 255, 0.1) !important;
    }
    
    /* No results message */
    .select2-container--default .select2-results__message {
        color: var(--text-secondary, #6c757d) !important;
        padding: 10px 16px !important;
    }
</style>

<div class="row gy-4">
    <div class="col-lg-8">
        <div class="card h-100 p-0 radius-12">
            <div class="card-header border-bottom bg-base py-16 px-24 d-flex align-items-center justify-content-between">
                <h6 class="text-lg fw-semibold mb-0">
                    <span data-i18n="common.edit">Edit</span> <span data-i18n="sidebar.orders">Order</span> #{{ order.get_order_number }}
                </h6>
                <a href="{% url 'orders:orderDetail' order.id %}" class="btn btn-outline-secondary btn-sm">
                    <iconify-icon icon="ep:back" class="me-1"></iconify-icon> <span data-i18n="detail.back">Back</span>
                </a>
            </div>
            <div class="card-body p-24">
                <form method="post" action="{% url 'orders:orderEdit' order.id %}" enctype="multipart/form-data">
                    {% csrf_token %}
                    
                    <!-- Manual Order Toggle -->
                    <div class="mb-20 p-16 bg-warning-50 radius-8 border border-warning-200">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="manualOrderToggle" {% if order.is_manual_order %}checked{% endif %}>
                            <label class="form-check-label fw-semibold" for="manualOrderToggle">
                                <iconify-icon icon="solar:phone-calling-bold" class="me-2 text-warning-600"></iconify-icon>
                                Manual Order (Phone/Walk-in)
                            </label>
                        </div>
                        <small class="text-secondary-light d-block mt-8">
                            Toggle to switch between bot user and manual customer information
                        </small>
                    </div>
                    
                    <!-- Customer Selection (Bot User) -->
                    <div class="mb-20" id="botUserSection" {% if order.is_manual_order %}style="display: none;"{% endif %}>
                        <label class="form-label fw-semibold text-primary-light text-sm mb-8" data-i18n="orders.customer">Customer</label>
                        <select name="bot_user" class="form-select radius-8" id="customerSelect" {% if not order.is_manual_order %}required{% endif %}>
                            <option value="">-- Select Customer --</option>
                            {% for user in bot_users %}
                            <option value="{{ user.id }}" {% if order.bot_user and order.bot_user.id == user.id %}selected{% endif %}>
                                {{ user.display_name }} {% if user.phone %}({{ user.phone }}){% endif %}
                            </option>
                            {% endfor %}
                        </select>
                        <small class="text-primary-light">Select from existing customers (registered via Telegram bot)</small>
                    </div>
                    
                    <!-- Manual Customer Info -->
                    <div id="manualCustomerSection" {% if not order.is_manual_order %}style="display: none;"{% endif %}>
                        <div class="mb-16 p-12 bg-info-50 radius-8 border border-info-200">
                            <iconify-icon icon="solar:info-circle-bold" class="text-info-600 me-2"></iconify-icon>
                            <span class="text-sm text-info-600 fw-medium">Manual customer details</span>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-20">
                                <label class="form-label fw-semibold text-primary-light text-sm mb-8">First Name *</label>
                                <input type="text" name="manual_first_name" id="manualFirstName" class="form-control radius-8" 
                                       value="{{ order.manual_first_name|default:'' }}" placeholder="Customer's first name"
                                       {% if order.is_manual_order %}required{% endif %}>
                            </div>
                            <div class="col-md-6 mb-20">
                                <label class="form-label fw-semibold text-primary-light text-sm mb-8">Last Name</label>
                                <input type="text" name="manual_last_name" id="manualLastName" class="form-control radius-8" 
                                       value="{{ order.manual_last_name|default:'' }}" placeholder="Customer's last name">
                            </div>
                        </div>
                        <div class="mb-20">
                            <label class="form-label fw-semibold text-primary-light text-sm mb-8">Phone Number *</label>
                            <input type="tel" name="manual_phone" id="manualPhone" class="form-control radius-8" 
                                   value="{{ order.manual_phone|default:'' }}" placeholder="+998 XX XXX XX XX"
                                   {% if order.is_manual_order %}required{% endif %}>
                            <small class="text-primary-light">Customer's contact number</small>
                        </div>
                    </div>
                    
                    <!-- Product and Language -->
                    <div class="row">
                        <div class="col-md-8 mb-20">
                            <label class="form-label fw-semibold text-primary-light text-sm mb-8" data-i18n="detail.productService">Product / Service</label>
                            <select name="product" class="form-select radius-8" required>
                                {% for product in products %}
                                <option value="{{ product.id }}" {% if order.product.id == product.id %}selected{% endif %}>
                                    {{ product.category.branch.center.name }} - {{ product.category.name }} | {{ product.name }} ({{ product.price|floatformat:0 }} UZS/page)
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-4 mb-20">
                            <label class="form-label fw-semibold text-primary-light text-sm mb-8" data-i18n="form.language">Language</label>
                            <select name="language" class="form-select radius-8">
                                <option value="">-- Optional --</option>
                                {% for language in languages %}
                                <option value="{{ language.id }}" {% if order.language and order.language.id == language.id %}selected{% endif %}>
                                    {{ language.name }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    
                    <!-- Total Pages, Copies, and Payment Type -->
                    <div class="row">
                        <div class="col-md-4 mb-20">
                            <label class="form-label fw-semibold text-primary-light text-sm mb-8" data-i18n="detail.totalPages">Total Pages</label>
                            <input type="number" name="total_pages" class="form-control radius-8" value="{{ order.total_pages }}" min="1" required>
                        </div>
                        <div class="col-md-4 mb-20">
                            <label class="form-label fw-semibold text-primary-light text-sm mb-8" data-i18n="detail.copies">Copies</label>
                            <input type="number" name="copy_number" class="form-control radius-8" value="{{ order.copy_number }}" min="0">
                            <small class="text-primary-light d-block mt-4">0 = original only</small>
                        </div>
                        <div class="col-md-4 mb-20">
                            <label class="form-label fw-semibold text-primary-light text-sm mb-8" data-i18n="table.payment">Payment Type</label>
                            <select name="payment_type" class="form-select radius-8" required>
                                {% for value, label in payment_choices %}
                                <option value="{{ value }}" {% if order.payment_type == value %}selected{% endif %}>{{ label }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    
                    <!-- Description -->
                    <div class="mb-20">
                        <label class="form-label fw-semibold text-primary-light text-sm mb-8" data-i18n="form.description">Description</label>
                        <textarea name="description" class="form-control radius-8" rows="3" placeholder="Optional description...">{{ order.description|default:'' }}</textarea>
                    </div>
                    
                    <!-- Existing Files -->
                    {% if order.files.all %}
                    <div class="mb-20">
                        <label class="form-label fw-semibold text-primary-light text-sm mb-8">
                            <span data-i18n="detail.attachedFiles">Attached Files</span> ({{ order.files.count }})
                        </label>
                        <div class="table-responsive">
                            <table class="table bordered-table sm-table mb-0">
                                <thead>
                                    <tr>
                                        <th>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="selectAllFiles">
                                                <label class="form-check-label text-sm" for="selectAllFiles">Delete</label>
                                            </div>
                                        </th>
                                        <th data-i18n="detail.file">File</th>
                                        <th data-i18n="common.pages">Pages</th>
                                        <th data-i18n="table.action">Action</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for file in order.files.all %}
                                    <tr>
                                        <td>
                                            <div class="form-check">
                                                <input class="form-check-input file-checkbox" type="checkbox" name="delete_files" value="{{ file.id }}" id="file_{{ file.id }}">
                                            </div>
                                        </td>
                                        <td>
                                            <span class="text-sm">{{ file.file.name|slice:"-30:" }}</span>
                                        </td>
                                        <td>
                                            <span class="badge bg-info-focus text-info-600">{{ file.pages }}</span>
                                        </td>
                                        <td>
                                            <a href="{{ file.file.url }}" target="_blank" class="btn btn-sm btn-outline-primary">
                                                <iconify-icon icon="mdi:download"></iconify-icon>
                                            </a>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        <small class="text-danger mt-8 d-block">
                            <iconify-icon icon="mdi:alert" class="me-1"></iconify-icon>
                            Check the boxes to delete files when saving
                        </small>
                    </div>
                    {% endif %}
                    
                    <!-- Add New Files -->
                    <div class="mb-20">
                        <label class="form-label fw-semibold text-primary-light text-sm mb-8">
                            <iconify-icon icon="mdi:file-plus" class="me-1"></iconify-icon>
                            <span data-i18n="detail.addNewFiles">Add New Files</span>
                        </label>
                        <input type="file" name="new_files" class="form-control radius-8" multiple accept=".pdf,.doc,.docx,.jpg,.jpeg,.png">
                        <small class="text-primary-light mt-8 d-block">You can select multiple files. Supported: PDF, DOC, DOCX, JPG, PNG</small>
                    </div>
                    
                    <!-- Current Price Info -->
                    <div class="mb-20 p-16 bg-success-50 radius-8">
                        <div class="d-flex align-items-center justify-content-between mb-8">
                            <span class="text-secondary-light text-sm" data-i18n="detail.basePrice">Base Price</span>
                            <span class="text-md fw-medium">{{ order.total_price|floatformat:0 }} UZS</span>
                        </div>
                        {% if order.extra_fee > 0 %}
                        <div class="d-flex align-items-center justify-content-between mb-8">
                            <span class="text-secondary-light text-sm">Extra Fee</span>
                            <span class="text-md fw-medium text-warning-600">+{{ order.extra_fee|floatformat:0 }} UZS</span>
                        </div>
                        {% endif %}
                        <div class="d-flex align-items-center justify-content-between border-top pt-8">
                            <span class="text-secondary-light text-sm fw-semibold" data-i18n="detail.totalDue">Total Due</span>
                            <h5 class="text-success-600 fw-bold mb-0">{{ order.total_due|floatformat:0 }} UZS</h5>
                        </div>
                        {% if order.received > 0 %}
                        <div class="d-flex align-items-center justify-content-between mt-8">
                            <span class="text-secondary-light text-sm">Received</span>
                            <span class="text-md fw-medium text-primary-600">{{ order.received|floatformat:0 }} UZS</span>
                        </div>
                        <div class="d-flex align-items-center justify-content-between">
                            <span class="text-secondary-light text-sm">Remaining</span>
                            <span class="text-md fw-medium {% if order.remaining > 0 %}text-danger-600{% else %}text-success-600{% endif %}">{{ order.remaining|floatformat:0 }} UZS</span>
                        </div>
                        {% endif %}
                        <small class="text-primary-light">Price will be recalculated based on product and pages</small>
                    </div>
                    
                    <!-- Extra Fee Section -->
                    <div class="mb-20">
                        <label class="form-label fw-semibold text-primary-light text-sm mb-8">
                            <iconify-icon icon="mdi:cash-plus" class="me-1"></iconify-icon>
                            Extra Fee (Optional)
                        </label>
                        <div class="row">
                            <div class="col-md-4">
                                <input type="number" name="extra_fee" class="form-control radius-8" 
                                       value="{{ order.extra_fee|floatformat:0 }}" min="0" step="1000" placeholder="0">
                            </div>
                            <div class="col-md-8">
                                <input type="text" name="extra_fee_description" class="form-control radius-8" 
                                       value="{{ order.extra_fee_description|default:'' }}" placeholder="Reason for extra fee (e.g., Urgent delivery)">
                            </div>
                        </div>
                        <small class="text-primary-light mt-8 d-block">Add additional charges for express delivery, special handling, etc.</small>
                    </div>
                    
                    <!-- Submit Buttons -->
                    <div class="d-flex align-items-center gap-3">
                        <button type="submit" class="btn btn-primary px-32">
                            <iconify-icon icon="mdi:content-save" class="me-1"></iconify-icon> <span data-i18n="common.save">Save Changes</span>
                        </button>
                        <a href="{% url 'orders:orderDetail' order.id %}" class="btn btn-outline-secondary px-32">
                            <span data-i18n="common.cancel">Cancel</span>
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Order Info Sidebar -->
    <div class="col-lg-4">
        <!-- Customer Info -->
        <div class="card radius-12 mb-24">
            <div class="card-header border-bottom bg-base py-16 px-24">
                <h6 class="text-md fw-semibold mb-0" data-i18n="detail.customerInformation">Customer Information</h6>
            </div>
            <div class="card-body p-24">
                <div class="d-flex align-items-center gap-3 mb-16">
                    <div class="w-56-px h-56-px rounded-circle bg-primary-100 d-flex align-items-center justify-content-center">
                        <span class="text-primary-600 fw-bold text-xl">{{ order.bot_user.name|slice:":1"|upper }}</span>
                    </div>
                    <div>
                        <h6 class="text-md fw-semibold mb-4">{{ order.bot_user.name }}</h6>
                        {% if order.bot_user.username %}
                        <span class="text-secondary-light text-sm">@{{ order.bot_user.username }}</span>
                        {% endif %}
                    </div>
                </div>
                <div class="mb-12">
                    <span class="text-secondary-light text-sm" data-i18n="detail.phone">Phone</span>
                    <p class="text-md fw-medium mb-0">{{ order.bot_user.phone }}</p>
                </div>
            </div>
        </div>
        
        <!-- Order Status -->
        <div class="card radius-12">
            <div class="card-header border-bottom bg-base py-16 px-24">
                <h6 class="text-md fw-semibold mb-0">Order Status</h6>
            </div>
            <div class="card-body p-24">
                <div class="mb-16">
                    <span class="text-secondary-light text-sm d-block mb-8">Status</span>
                    {% if order.status == 'pending' %}
                        <span class="bg-warning-focus text-warning-600 px-16 py-6 radius-4 fw-medium text-sm">Pending</span>
                    {% elif order.status == 'payment_pending' %}
                        <span class="bg-info-focus text-info-600 px-16 py-6 radius-4 fw-medium text-sm">Awaiting</span>
                    {% elif order.status == 'payment_received' %}
                        <span class="bg-primary-focus text-primary-600 px-16 py-6 radius-4 fw-medium text-sm">Received</span>
                    {% elif order.status == 'payment_confirmed' %}
                        <span class="bg-cyan-focus text-cyan px-16 py-6 radius-4 fw-medium text-sm">Confirmed</span>
                    {% elif order.status == 'in_progress' %}
                        <span class="bg-lilac-focus text-lilac-600 px-16 py-6 radius-4 fw-medium text-sm">In Process</span>
                    {% elif order.status == 'ready' %}
                        <span class="bg-success-focus text-success-600 px-16 py-6 radius-4 fw-medium text-sm">Ready</span>
                    {% elif order.status == 'completed' %}
                        <span class="bg-success-focus text-success-600 px-16 py-6 radius-4 fw-medium text-sm">Done</span>
                    {% elif order.status == 'cancelled' %}
                        <span class="bg-danger-focus text-danger-600 px-16 py-6 radius-4 fw-medium text-sm">Cancelled</span>
                    {% endif %}
                </div>
                <div class="mb-16">
                    <span class="text-secondary-light text-sm d-block mb-8">Created</span>
                    <span class="text-md fw-medium">{{ order.created_at|date:"d M Y, H:i" }}</span>
                </div>
                {% if order.branch %}
                <div>
                    <span class="text-secondary-light text-sm d-block mb-8">Branch</span>
                    <span class="text-md fw-medium">{{ order.branch.name }}</span>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Select2 JS -->
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
// Manual order toggle functionality
document.addEventListener('DOMContentLoaded', function() {
    // Initialize Select2 for customer search
    $('#customerSelect').select2({
        ajax: {
            url: "{% url 'orders:search_customers' %}",
            dataType: 'json',
            delay: 250,
            data: function (params) {
                return {
                    q: params.term // search term
                };
            },
            processResults: function (data) {
                return {
                    results: data.results
                };
            },
            cache: true
        },
        placeholder: '-- Select Customer --',
        allowClear: true,
        minimumInputLength: 0,
        width: '100%'
    });
    
    // Set initial selection if there's a current customer
    {% if order.bot_user %}
    var currentCustomer = new Option(
        '{{ order.bot_user.display_name }}{% if order.bot_user.phone %} ({{ order.bot_user.phone }}){% endif %}',
        '{{ order.bot_user.id }}',
        true,
        true
    );
    $('#customerSelect').append(currentCustomer).trigger('change');
    {% endif %}
    
    const manualOrderToggle = document.getElementById('manualOrderToggle');
    const botUserSection = document.getElementById('botUserSection');
    const manualCustomerSection = document.getElementById('manualCustomerSection');
    const customerSelect = document.getElementById('customerSelect');
    const manualFirstName = document.getElementById('manualFirstName');
    const manualPhone = document.getElementById('manualPhone');
    
    if (manualOrderToggle) {
        manualOrderToggle.addEventListener('change', function() {
            if (this.checked) {
                // Show manual fields, hide bot user selection
                botUserSection.style.display = 'none';
                manualCustomerSection.style.display = 'block';
                
                // Update field requirements
                customerSelect.removeAttribute('required');
                customerSelect.value = '';
                manualFirstName.setAttribute('required', 'required');
                manualPhone.setAttribute('required', 'required');
            } else {
                // Show bot user selection, hide manual fields
                botUserSection.style.display = 'block';
                manualCustomerSection.style.display = 'none';
                
                // Update field requirements
                customerSelect.setAttribute('required', 'required');
                manualFirstName.removeAttribute('required');
                manualPhone.removeAttribute('required');
                
                // Clear manual fields
                manualFirstName.value = '';
                document.getElementById('manualLastName').value = '';
                manualPhone.value = '';
            }
        });
    }
    
    // Select all files checkbox functionality
    const selectAllCheckbox = document.getElementById('selectAllFiles');
    const fileCheckboxes = document.querySelectorAll('.file-checkbox');
    
    if (selectAllCheckbox) {
        selectAllCheckbox.addEventListener('change', function() {
            fileCheckboxes.forEach(function(checkbox) {
                checkbox.checked = selectAllCheckbox.checked;
            });
        });
        
        // Update "select all" state when individual checkboxes change
        fileCheckboxes.forEach(function(checkbox) {
            checkbox.addEventListener('change', function() {
                const allChecked = Array.from(fileCheckboxes).every(cb => cb.checked);
                const someChecked = Array.from(fileCheckboxes).some(cb => cb.checked);
                selectAllCheckbox.checked = allChecked;
                selectAllCheckbox.indeterminate = someChecked && !allChecked;
            });
        });
    }
});
</script>
{% endblock content %}
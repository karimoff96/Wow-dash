{% extends './layout/layout.html' %} 

{% block content %}
<!-- Filter Bar -->
<div class="card radius-8 border-0 mb-24">
    <div class="card-body p-16">
        <form method="GET" class="d-flex align-items-center gap-3">
            <span class="text-md fw-semibold text-secondary-light" data-i18n="filter.defaultPeriod">Default Period:</span>
            <select name="period" id="mainPeriodSelect" class="form-select form-select-sm w-auto">
                <option value="today" {% if period == 'today' %}selected{% endif %} data-i18n="filter.today">Today</option>
                <option value="week" {% if period == 'week' %}selected{% endif %} data-i18n="filter.thisWeek">This Week</option>
                <option value="month" {% if period == 'month' %}selected{% endif %} data-i18n="filter.thisMonth">This Month</option>
                <option value="year" {% if period == 'year' %}selected{% endif %} data-i18n="filter.thisYear">This Year</option>
                <option value="custom" {% if period == 'custom' %}selected{% endif %} data-i18n="filter.custom">Custom Range</option>
            </select>
            <div id="customDateRange" class="d-flex gap-2" style="{% if period != 'custom' %}display: none;{% endif %}">
                <input type="date" name="date_from" class="form-control form-control-sm" value="{{ date_from }}" style="width: 150px;">
                <input type="date" name="date_to" class="form-control form-control-sm" value="{{ date_to }}" style="width: 150px;">
            </div>
            <button type="submit" class="btn btn-primary btn-sm px-16 d-inline-flex align-items-center gap-2">
                <iconify-icon icon="solar:filter-bold" class="icon"></iconify-icon>
                <span data-i18n="common.apply">Apply</span>
            </button>
            {% if period_label %}
            <span class="badge bg-primary-light text-primary-main px-12 py-6">
                <iconify-icon icon="solar:calendar-bold" class="me-1"></iconify-icon>
                {{ period_label }}
            </span>
            {% endif %}
        </form>
    </div>
</div>

<div class="row gy-4">
    <!-- Row 1: Quick Stats Cards -->
    <div class="col-xxl-3 col-sm-6">
        <div class="card p-3 shadow-2 radius-8 border input-form-light h-100 bg-gradient-end-1">
            <div class="card-body p-0">
                <div class="d-flex flex-wrap align-items-center justify-content-between gap-1 mb-8">
                    <div class="d-flex align-items-center gap-2">
                        <span class="mb-0 w-48-px h-48-px bg-primary-600 flex-shrink-0 text-white d-flex justify-content-center align-items-center rounded-circle h6">
                            <iconify-icon icon="solar:bag-4-bold" class="icon"></iconify-icon>
                        </span>
                        <div>
                            <span class="mb-2 fw-medium text-secondary-light text-sm" data-i18n="sales.totalOrders">Total Orders</span>
                            <h6 class="fw-semibold" id="totalOrdersCard">{{ yearly_count }}</h6>
                        </div>
                    </div>
                </div>
                <p class="text-sm mb-0">
                    <span class="bg-success-focus px-1 rounded-2 fw-medium text-success-main text-sm" id="ordersChangeBadge">
                        <iconify-icon icon="bxs:up-arrow" class="text-xs"></iconify-icon> {{ yearly_change }}%
                    </span>
                    <span class="text-secondary-light" data-i18n="sales.vsLastPeriod">vs last period</span>
                </p>
            </div>
        </div>
    </div>

    <div class="col-xxl-3 col-sm-6">
        <div class="card p-3 shadow-2 radius-8 border input-form-light h-100 bg-gradient-end-2">
            <div class="card-body p-0">
                <div class="d-flex flex-wrap align-items-center justify-content-between gap-1 mb-8">
                    <div class="d-flex align-items-center gap-2">
                        <span class="mb-0 w-48-px h-48-px bg-success-main flex-shrink-0 text-white d-flex justify-content-center align-items-center rounded-circle h6">
                            <iconify-icon icon="solar:wallet-money-bold" class="icon"></iconify-icon>
                        </span>
                        <div>
                            <span class="mb-2 fw-medium text-secondary-light text-sm" data-i18n="sales.totalRevenue">Total Revenue</span>
                            <h6 class="fw-semibold" id="totalRevenueCard">{{ yearly_revenue|floatformat:0 }} <small class="text-xs fw-normal">UZS</small></h6>
                        </div>
                    </div>
                </div>
                <p class="text-sm mb-0">
                    <span class="text-secondary-light">+{{ yearly_daily_avg|floatformat:0 }} UZS/<span data-i18n="common.dayAvg">day avg</span></span>
                </p>
            </div>
        </div>
    </div>

    <div class="col-xxl-3 col-sm-6">
        <div class="card p-3 shadow-2 radius-8 border input-form-light h-100 bg-gradient-end-3">
            <div class="card-body p-0">
                <div class="d-flex flex-wrap align-items-center justify-content-between gap-1 mb-8">
                    <div class="d-flex align-items-center gap-2">
                        <span class="mb-0 w-48-px h-48-px bg-yellow text-white flex-shrink-0 d-flex justify-content-center align-items-center rounded-circle h6">
                            <iconify-icon icon="solar:check-circle-bold" class="icon"></iconify-icon>
                        </span>
                        <div>
                            <span class="mb-2 fw-medium text-secondary-light text-sm" data-i18n="status.completed">Completed</span>
                            <h6 class="fw-semibold" id="completedCard">0</h6>
                        </div>
                    </div>
                </div>
                <p class="text-sm mb-0">
                    <span class="bg-success-focus px-1 rounded-2 fw-medium text-success-main text-sm" id="completionRateCard">0%</span>
                    <span class="text-secondary-light" data-i18n="sales.completionRate">completion rate</span>
                </p>
            </div>
        </div>
    </div>

    <div class="col-xxl-3 col-sm-6">
        <div class="card p-3 shadow-2 radius-8 border input-form-light h-100 bg-gradient-end-6">
            <div class="card-body p-0">
                <div class="d-flex flex-wrap align-items-center justify-content-between gap-1 mb-8">
                    <div class="d-flex align-items-center gap-2">
                        <span class="mb-0 w-48-px h-48-px bg-danger-main text-white flex-shrink-0 d-flex justify-content-center align-items-center rounded-circle h6">
                            <iconify-icon icon="solar:close-circle-bold" class="icon"></iconify-icon>
                        </span>
                        <div>
                            <span class="mb-2 fw-medium text-secondary-light text-sm" data-i18n="status.cancelled">Cancelled</span>
                            <h6 class="fw-semibold" id="cancelledCard">0</h6>
                        </div>
                    </div>
                </div>
                <p class="text-sm mb-0">
                    <span class="text-secondary-light" data-i18n="sales.ordersCancelled">Orders cancelled</span>
                </p>
            </div>
        </div>
    </div>

    <!-- Orders Overview Chart -->
    <div class="col-xxl-8">
        <div class="card h-100 radius-8 border">
            <div class="card-body p-24">
                <div class="d-flex align-items-center flex-wrap gap-2 justify-content-between">
                    <div>
                        <h6 class="mb-2 fw-bold text-lg" data-i18n="sales.ordersOverview">Orders Overview</h6>
                        <span class="text-sm fw-medium text-secondary-light" data-i18n="sales.trackPerformance">Track your order performance</span>
                    </div>
                    <select class="form-select form-select-sm w-auto bg-base border text-secondary-light radius-8 px-16" id="ordersPeriodSelect">
                        <option value="yearly" selected data-i18n="common.yearly">Yearly</option>
                        <option value="monthly" data-i18n="common.monthly">Monthly</option>
                        <option value="weekly" data-i18n="common.weekly">Weekly</option>
                        <option value="today" data-i18n="common.today">Today</option>
                    </select>
                </div>
                <div id="ordersChart" class="mt-28 apexcharts-tooltip-style-1"></div>
            </div>
        </div>
    </div>

    <!-- Orders by Status -->
    <div class="col-xxl-4">
        <div class="card h-100 radius-8 border">
            <div class="card-body p-24">
                <div class="d-flex align-items-center flex-wrap gap-2 justify-content-between">
                    <h6 class="mb-2 fw-bold text-lg" data-i18n="sales.ordersByStatus">Orders by Status</h6>
                    <select class="form-select form-select-sm w-auto bg-base border text-secondary-light radius-8" id="statusPeriodSelect">
                        <option value="yearly" selected data-i18n="common.yearly">Yearly</option>
                        <option value="monthly" data-i18n="common.monthly">Monthly</option>
                        <option value="weekly" data-i18n="common.weekly">Weekly</option>
                        <option value="today" data-i18n="common.today">Today</option>
                    </select>
                </div>
                <div id="statusDonutChart" class="mt-16"></div>
                <div class="mt-16" id="statusLegend"></div>
            </div>
        </div>
    </div>

    <!-- Recent Orders Table - Full Width -->
    <div class="col-12">
        <div class="card radius-8 border">
            <div class="card-header border-bottom bg-base py-16 px-24 d-flex align-items-center justify-content-between">
                <h6 class="text-lg fw-semibold mb-0" data-i18n="sales.recentOrders">Recent Orders</h6>
                <a href="{% url 'orders:ordersList' %}" class="text-primary-600 hover-text-primary d-flex align-items-center gap-1">
                    <span data-i18n="common.viewAll">View All</span> <iconify-icon icon="solar:alt-arrow-right-linear" class="icon"></iconify-icon>
                </a>
            </div>
            <div class="card-body p-24">
                <div class="table-responsive">
                    <table class="table bordered-table mb-0">
                        <thead>
                            <tr>
                                <th scope="col" class="col-id" data-i18n="table.orderId">#</th>
                                {% if user.is_superuser or is_owner %}
                                <th scope="col" data-i18n="table.location">Location</th>
                                {% endif %}
                                <th scope="col" data-i18n="table.customer">Customer</th>
                                <th scope="col" class="hide-mobile" data-i18n="table.product">Product</th>
                                <th scope="col" class="col-amount" data-i18n="table.amount">Amount</th>
                                <th scope="col" class="col-date hide-mobile" data-i18n="table.date">Date</th>
                                <th scope="col" class="col-status" data-i18n="table.status">Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for order in recent_orders %}
                            <tr>
                                <td class="col-id"><span class="text-primary-600 fw-medium">{{ order.id }}</span></td>
                                {% if user.is_superuser or is_owner %}
                                <td class="cell-merged-info">
                                    {% if user.is_superuser %}
                                    <span class="cell-primary truncate-120">{{ order.center|default:"-"|truncatechars:12 }}</span>
                                    {% endif %}
                                    <span class="cell-secondary truncate-120">{{ order.branch|default:"-"|truncatechars:15 }}</span>
                                </td>
                                {% endif %}
                                <td class="truncate-150"><span class="text-primary-light fw-medium">{{ order.customer|truncatechars:18 }}</span></td>
                                <td class="truncate-120 hide-mobile"><span class="text-secondary-light">{{ order.product|truncatechars:15 }}</span></td>
                                <td class="col-amount"><span class="fw-medium nowrap">{{ order.total_price|floatformat:0 }}</span></td>
                                <td class="col-date hide-mobile"><span class="text-secondary-light text-xs">{{ order.created_at|date:"d/m H:i" }}</span></td>
                                <td class="col-status">
                                    {% if order.status == 'completed' %}
                                    <span class="bg-success-focus text-success-main status-badge-sm rounded-pill fw-medium" data-i18n="status.completed">Done</span>
                                    {% elif order.status == 'cancelled' %}
                                    <span class="bg-danger-focus text-danger-main status-badge-sm rounded-pill fw-medium" data-i18n="status.cancelled">Cancel</span>
                                    {% elif order.status == 'in_progress' %}
                                    <span class="bg-info-focus text-info-main status-badge-sm rounded-pill fw-medium" data-i18n="status.inProgress">Active</span>
                                    {% else %}
                                    <span class="bg-warning-focus text-warning-main status-badge-sm rounded-pill fw-medium" data-i18n="status.pending">Pend</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% empty %}
                            <tr><td colspan="{% if user.is_superuser or is_owner %}7{% else %}5{% endif %}" class="text-center text-secondary-light py-24" data-i18n="table.noRecentOrders">No recent orders</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Top Agencies & Top Customers Side by Side -->
    <div class="col-xxl-6">
        <div class="card h-100 radius-8 border">
            <div class="card-header border-bottom bg-base py-16 px-24 d-flex align-items-center justify-content-between">
                <h6 class="text-lg fw-semibold mb-0" data-i18n="sales.top5Agencies">Top 5 Agencies</h6>
                <select class="form-select form-select-sm w-auto bg-base border text-secondary-light radius-8" id="agenciesPeriodSelect">
                    <option value="yearly" selected data-i18n="common.yearly">Yearly</option>
                    <option value="monthly" data-i18n="common.monthly">Monthly</option>
                    <option value="weekly" data-i18n="common.weekly">Weekly</option>
                    <option value="today" data-i18n="common.today">Today</option>
                </select>
            </div>
            <div class="card-body p-24">
                <div class="table-responsive">
                    <table class="table bordered-table mb-0">
                        <thead>
                            <tr>
                                <th scope="col" class="col-id">#</th>
                                <th scope="col" data-i18n="table.agency">Agency</th>
                                <th scope="col" class="text-center col-id" data-i18n="table.orders">#</th>
                                <th scope="col" class="col-amount" data-i18n="table.revenue">Revenue</th>
                            </tr>
                        </thead>
                        <tbody id="agenciesTableBody"></tbody>
                    </table>
                    <div id="noAgenciesMessage" class="text-center py-24 d-none">
                        <span class="text-secondary-light text-sm" data-i18n="table.noAgenciesFound">No agencies found</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xxl-6">
        <div class="card h-100 radius-8 border">
            <div class="card-header border-bottom bg-base py-16 px-24 d-flex align-items-center justify-content-between">
                <h6 class="text-lg fw-semibold mb-0" data-i18n="sales.top5Customers">Top 5 Customers</h6>
                <select class="form-select form-select-sm w-auto bg-base border text-secondary-light radius-8" id="customersPeriodSelect">
                    <option value="yearly" selected data-i18n="common.yearly">Yearly</option>
                    <option value="monthly" data-i18n="common.monthly">Monthly</option>
                    <option value="weekly" data-i18n="common.weekly">Weekly</option>
                    <option value="today" data-i18n="common.today">Today</option>
                </select>
            </div>
            <div class="card-body p-24">
                <div class="table-responsive">
                    <table class="table bordered-table mb-0">
                        <thead>
                            <tr>
                                <th scope="col" class="col-id">#</th>
                                <th scope="col" data-i18n="table.customer">Customer</th>
                                <th scope="col" class="text-center col-id" data-i18n="table.orders">#</th>
                                <th scope="col" class="col-amount" data-i18n="table.revenue">Revenue</th>
                            </tr>
                        </thead>
                        <tbody id="customersTableBody"></tbody>
                    </table>
                    <div id="noCustomersMessage" class="text-center py-24 d-none">
                        <span class="text-secondary-light text-sm" data-i18n="table.noCustomersFound">No customers found</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock content %}

{% block script %}
<script>
// Main period filter toggle for custom date range
const mainPeriodSelect = document.getElementById('mainPeriodSelect');
const customDateRange = document.getElementById('customDateRange');

if (mainPeriodSelect && customDateRange) {
    mainPeriodSelect.addEventListener('change', function() {
        if (this.value === 'custom') {
            customDateRange.style.display = 'flex';
        } else {
            customDateRange.style.display = 'none';
            // Auto-submit when not custom
            this.form.submit();
        }
    });
}

const ordersData = {
    today: { count: {{ today_count }}, revenue: {{ today_revenue }}, change: {{ today_change }}, dailyAvg: {{ today_daily_avg }}, chartData: {{ today_chart_data|safe }}, chartLabels: {{ today_chart_labels|safe }} },
    weekly: { count: {{ weekly_count }}, revenue: {{ weekly_revenue }}, change: {{ weekly_change }}, dailyAvg: {{ weekly_daily_avg }}, chartData: {{ weekly_chart_data|safe }}, chartLabels: {{ weekly_chart_labels|safe }} },
    monthly: { count: {{ monthly_count }}, revenue: {{ monthly_revenue }}, change: {{ monthly_change }}, dailyAvg: {{ monthly_daily_avg }}, chartData: {{ monthly_chart_data|safe }}, chartLabels: {{ monthly_chart_labels|safe }} },
    yearly: { count: {{ yearly_count }}, revenue: {{ yearly_revenue }}, change: {{ yearly_change }}, dailyAvg: {{ yearly_daily_avg }}, chartData: {{ yearly_chart_data|safe }}, chartLabels: {{ yearly_chart_labels|safe }} }
};
const statusChartData = {{ status_chart_data|safe }};
const topAgenciesData = {{ top_agencies_data|safe }};
const topCustomersData = {{ top_customers_data|safe }};
const completionRatesData = {{ completion_rates|safe }};

function formatNumber(num) { return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ","); }
function formatShort(num) {
    num = parseFloat(num) || 0;
    if (num >= 1000000000) return (num / 1000000000).toFixed(1) + 'B';
    if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
    if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
    return num.toFixed(0);
}
function getThemeColors() {
    const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
    return { textColor: isDark ? '#9CA3AF' : '#6C757D', gridColor: isDark ? '#374151' : '#E4E7EC', bgColor: isDark ? '#1F2937' : '#ffffff' };
}

// Update stat cards
function updateStatCards(period) {
    const data = ordersData[period];
    const completion = completionRatesData[period];
    document.getElementById('totalOrdersCard').textContent = formatNumber(data.count);
    document.getElementById('totalRevenueCard').innerHTML = formatNumber(data.revenue) + ' <small class="text-xs fw-normal">UZS</small>';
    document.getElementById('completedCard').textContent = formatNumber(completion.completed);
    document.getElementById('cancelledCard').textContent = formatNumber(completion.cancelled);
    document.getElementById('completionRateCard').textContent = completion.rate + '%';
    const badge = document.getElementById('ordersChangeBadge');
    badge.innerHTML = '<iconify-icon icon="bxs:' + (data.change >= 0 ? 'up' : 'down') + '-arrow" class="text-xs"></iconify-icon> ' + data.change + '%';
    badge.className = data.change >= 0 ? 'bg-success-focus px-1 rounded-2 fw-medium text-success-main text-sm' : 'bg-danger-focus px-1 rounded-2 fw-medium text-danger-main text-sm';
}

// Orders Chart
let ordersChart;
function initOrdersChart() {
    const colors = getThemeColors();
    const data = ordersData.yearly;
    ordersChart = new ApexCharts(document.querySelector("#ordersChart"), {
        series: [{ name: 'Orders', data: data.chartData }],
        chart: { type: 'area', height: 264, toolbar: { show: false } },
        colors: ['#487FFF'],
        fill: { type: 'gradient', gradient: { shadeIntensity: 1, opacityFrom: 0.4, opacityTo: 0.1 } },
        stroke: { curve: 'smooth', width: 2 },
        dataLabels: { enabled: false },
        xaxis: { categories: data.chartLabels, labels: { style: { colors: colors.textColor, fontSize: '12px' } }, axisBorder: { show: false }, axisTicks: { show: false } },
        yaxis: { labels: { style: { colors: colors.textColor, fontSize: '12px' } } },
        grid: { borderColor: colors.gridColor, strokeDashArray: 3 },
        tooltip: { y: { formatter: val => formatNumber(val) + ' orders' } }
    });
    ordersChart.render();
}

function updateOrdersChart(period) {
    const data = ordersData[period];
    ordersChart.updateOptions({ xaxis: { categories: data.chartLabels } });
    ordersChart.updateSeries([{ name: 'Orders', data: data.chartData }]);
}

// Status Donut Chart
let statusDonutChart;
function updateStatusLegend(period) {
    const data = statusChartData[period];
    let html = '<div class="d-flex flex-column gap-8">';
    for (let i = 0; i < data.labels.length; i++) {
        html += '<div class="d-flex align-items-center justify-content-between">' +
            '<div class="d-flex align-items-center gap-8">' +
            '<span class="w-12-px h-12-px rounded-circle" style="background:' + data.colors[i] + '"></span>' +
            '<span class="text-secondary-light text-sm">' + data.labels[i] + '</span></div>' +
            '<span class="fw-medium text-primary-light text-sm">' + data.values[i] + '</span></div>';
    }
    html += '</div>';
    document.getElementById('statusLegend').innerHTML = html;
}

function updateStatusChart(period) {
    const data = statusChartData[period];
    updateStatusLegend(period);
    if (statusDonutChart) {
        statusDonutChart.updateOptions({ labels: data.labels, colors: data.colors });
        statusDonutChart.updateSeries(data.values);
    }
}

function initStatusDonutChart() {
    const colors = getThemeColors();
    const data = statusChartData.yearly;
    statusDonutChart = new ApexCharts(document.querySelector("#statusDonutChart"), {
        series: data.values,
        chart: { type: 'donut', height: 200 },
        labels: data.labels,
        colors: data.colors,
        legend: { show: false },
        dataLabels: { enabled: false },
        plotOptions: { pie: { donut: { size: '70%', labels: { show: true, name: { show: true, fontSize: '12px', color: colors.textColor }, value: { show: true, fontSize: '14px', fontWeight: 600, color: colors.textColor, formatter: val => formatShort(val) }, total: { show: true, label: 'Total', color: colors.textColor, formatter: w => w.globals.seriesTotals.reduce((a,b) => a+b, 0) } } } } }
    });
    statusDonutChart.render();
    updateStatusLegend('yearly');
}

// Top Tables
function updateAgenciesTable(period) {
    const agencies = topAgenciesData[period] || [];
    const tbody = document.getElementById('agenciesTableBody');
    const empty = document.getElementById('noAgenciesMessage');
    if (!agencies || agencies.length === 0) {
        tbody.innerHTML = '';
        empty.classList.remove('d-none');
        return;
    }
    empty.classList.add('d-none');
    tbody.innerHTML = agencies.map((a, i) => 
        '<tr><td class="text-primary-600 fw-medium">' + (i+1) + '</td>' +
        '<td><span class="text-primary-light fw-medium">' + a.name + '</span></td>' +
        '<td class="text-center"><span class="bg-info-focus text-info-main px-12 py-4 rounded-pill fw-medium text-sm">' + a.order_count + '</span></td>' +
        '<td class="fw-medium">' + formatNumber(a.total_spent) + ' UZS</td></tr>'
    ).join('');
}

function updateCustomersTable(period) {
    const customers = topCustomersData[period] || [];
    const tbody = document.getElementById('customersTableBody');
    const empty = document.getElementById('noCustomersMessage');
    if (!customers || customers.length === 0) {
        tbody.innerHTML = '';
        empty.classList.remove('d-none');
        return;
    }
    empty.classList.add('d-none');
    tbody.innerHTML = customers.map((c, i) => 
        '<tr><td class="text-primary-600 fw-medium">' + (i+1) + '</td>' +
        '<td><span class="text-primary-light fw-medium">' + c.name + '</span></td>' +
        '<td class="text-center"><span class="bg-success-focus text-success-main px-12 py-4 rounded-pill fw-medium text-sm">' + c.order_count + '</span></td>' +
        '<td class="fw-medium">' + formatNumber(c.total_spent) + ' UZS</td></tr>'
    ).join('');
}

document.addEventListener('DOMContentLoaded', function() {
    initOrdersChart();
    initStatusDonutChart();
    updateStatCards('yearly');
    updateAgenciesTable('yearly');
    updateCustomersTable('yearly');
    
    document.getElementById('ordersPeriodSelect').addEventListener('change', function(e) {
        const period = e.target.value;
        updateStatCards(period);
        updateOrdersChart(period);
    });
    
    document.getElementById('statusPeriodSelect').addEventListener('change', e => updateStatusChart(e.target.value));
    document.getElementById('agenciesPeriodSelect').addEventListener('change', e => updateAgenciesTable(e.target.value));
    document.getElementById('customersPeriodSelect').addEventListener('change', e => updateCustomersTable(e.target.value));
});
</script>
{% endblock script %}

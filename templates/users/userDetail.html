{% extends '../layout/layout.html' %}
{% load static %}

{% block content %}
<div class="row gy-4">
    <!-- User Info Card -->
    <div class="col-lg-4">
        <div class="card h-100 radius-16 overflow-hidden">
            <div class="card-header bg-base border-bottom py-16 px-24">
                <div class="d-flex align-items-center justify-content-between">
                    <h6 class="mb-0" data-i18n="detail.userInformation">User Information</h6>
                    <div class="d-flex align-items-center gap-2">
                        <a href="{% url 'editUser' bot_user.id %}" class="btn btn-sm btn-outline-warning-600 radius-8 px-12 py-6 d-flex align-items-center">
                            <iconify-icon icon="lucide:edit" class="me-4"></iconify-icon>
                            <span data-i18n="detail.edit">Edit</span>
                        </a>
                        {% if bot_user.is_active %}
                            <span class="bg-success-focus text-success-600 px-16 py-4 radius-4 fw-medium text-sm" data-i18n="common.active">Active</span>
                        {% else %}
                            <span class="bg-neutral-200 text-neutral-600 px-16 py-4 radius-4 fw-medium text-sm" data-i18n="common.inactive">Inactive</span>
                        {% endif %}
                    </div>
                </div>
            </div>
            <div class="card-body p-24">
                <div class="text-center mb-24">
                    <div class="w-120-px h-120-px rounded-circle bg-primary-100 d-flex align-items-center justify-content-center mx-auto mb-16">
                        <span class="text-primary-600 fw-bold" style="font-size: 48px;">{{ bot_user.name|slice:":1"|upper }}</span>
                    </div>
                    <h5 class="mb-4">{{ bot_user.name }}</h5>
                    {% if bot_user.username %}
                        <span class="text-secondary-light">@{{ bot_user.username }}</span>
                    {% endif %}
                    {% if bot_user.is_agency %}
                        <div class="mt-8">
                            <span class="badge bg-warning-focus text-warning-600 px-12 py-6 radius-4 d-inline-flex align-items-center">
                                <iconify-icon icon="mdi:office-building" class="me-4"></iconify-icon>
                                <span data-i18n="detail.agencyAccount">Agency Account</span>
                            </span>
                        </div>
                    {% endif %}
                </div>

                <div class="border-top pt-24">
                    <h6 class="text-md mb-16" data-i18n="detail.personalDetails">Personal Details</h6>
                    <ul class="list-unstyled">
                        <li class="d-flex align-items-center gap-8 mb-16">
                            <div class="w-40-px h-40-px rounded-circle bg-primary-50 d-flex align-items-center justify-content-center flex-shrink-0">
                                <iconify-icon icon="solar:user-linear" class="text-primary-600 text-xl"></iconify-icon>
                            </div>
                            <div class="flex-grow-1">
                                <span class="text-sm text-secondary-light d-block" data-i18n="form.fullName">Full Name</span>
                                <span class="text-md fw-medium">{{ bot_user.name }}</span>
                            </div>
                        </li>
                        <li class="d-flex align-items-center gap-8 mb-16">
                            <div class="w-40-px h-40-px rounded-circle bg-info-50 d-flex align-items-center justify-content-center flex-shrink-0">
                                <iconify-icon icon="ic:outline-telegram" class="text-info-600 text-xl"></iconify-icon>
                            </div>
                            <div class="flex-grow-1">
                                <span class="text-sm text-secondary-light d-block" data-i18n="detail.telegramId">Telegram ID</span>
                                <span class="text-md fw-medium">{{ bot_user.user_id|default:"-" }}</span>
                            </div>
                        </li>
                        <li class="d-flex align-items-center gap-8 mb-16">
                            <div class="w-40-px h-40-px rounded-circle bg-success-50 d-flex align-items-center justify-content-center flex-shrink-0">
                                <iconify-icon icon="solar:phone-linear" class="text-success-600 text-xl"></iconify-icon>
                            </div>
                            <div class="flex-grow-1">
                                <span class="text-sm text-secondary-light d-block" data-i18n="form.phoneNumber">Phone Number</span>
                                <span class="text-md fw-medium">{{ bot_user.phone }}</span>
                            </div>
                        </li>
                        <li class="d-flex align-items-center gap-8 mb-16">
                            <div class="w-40-px h-40-px rounded-circle bg-warning-50 d-flex align-items-center justify-content-center flex-shrink-0">
                                <iconify-icon icon="solar:global-linear" class="text-warning-600 text-xl"></iconify-icon>
                            </div>
                            <div class="flex-grow-1">
                                <span class="text-sm text-secondary-light d-block" data-i18n="form.language">Language</span>
                                <span class="text-md fw-medium">
                                    {% if bot_user.language == 'uz' %}
                                        ðŸ‡ºðŸ‡¿ Uzbek
                                    {% elif bot_user.language == 'ru' %}
                                        ðŸ‡·ðŸ‡º Russian
                                    {% elif bot_user.language == 'en' %}
                                        ðŸ‡¬ðŸ‡§ English
                                    {% else %}
                                        {{ bot_user.language }}
                                    {% endif %}
                                </span>
                            </div>
                        </li>
                        <li class="d-flex align-items-center gap-8 mb-16">
                            <div class="w-40-px h-40-px rounded-circle bg-danger-50 d-flex align-items-center justify-content-center flex-shrink-0">
                                <iconify-icon icon="solar:calendar-linear" class="text-danger-600 text-xl"></iconify-icon>
                            </div>
                            <div class="flex-grow-1">
                                <span class="text-sm text-secondary-light d-block" data-i18n="detail.joinedDate">Joined Date</span>
                                <span class="text-md fw-medium">{{ bot_user.created_at|date:"d M Y, H:i" }}</span>
                            </div>
                        </li>
                        {% if bot_user.center %}
                        <li class="d-flex align-items-center gap-8 mb-16">
                            <div class="w-40-px h-40-px rounded-circle bg-cyan-50 d-flex align-items-center justify-content-center flex-shrink-0">
                                <iconify-icon icon="mdi:office-building" class="text-cyan-600 text-xl"></iconify-icon>
                            </div>
                            <div class="flex-grow-1">
                                <span class="text-sm text-secondary-light d-block" data-i18n="detail.center">Center</span>
                                <span class="text-md fw-medium">{{ bot_user.center.name }}</span>
                            </div>
                        </li>
                        {% endif %}
                        {% if bot_user.branch %}
                        <li class="d-flex align-items-center gap-8 mb-16">
                            <div class="w-40-px h-40-px rounded-circle bg-indigo-50 d-flex align-items-center justify-content-center flex-shrink-0">
                                <iconify-icon icon="mdi:store" class="text-indigo-600 text-xl"></iconify-icon>
                            </div>
                            <div class="flex-grow-1">
                                <span class="text-sm text-secondary-light d-block" data-i18n="detail.branch">Branch</span>
                                <span class="text-md fw-medium">{{ bot_user.branch.name }}</span>
                            </div>
                        </li>
                        {% endif %}
                        {% if bot_user.agency %}
                        <li class="d-flex align-items-center gap-8">
                            <div class="w-40-px h-40-px rounded-circle bg-purple-50 d-flex align-items-center justify-content-center flex-shrink-0">
                                <iconify-icon icon="mdi:office-building-outline" class="text-purple-600 text-xl"></iconify-icon>
                            </div>
                            <div class="flex-grow-1">
                                <span class="text-sm text-secondary-light d-block" data-i18n="detail.referredByAgency">Referred By Agency</span>
                                <a href="{% url 'userDetail' %}?id={{ bot_user.agency.id }}" class="text-md fw-medium text-primary-600">
                                    {{ bot_user.agency.name }}
                                </a>
                            </div>
                        </li>
                        {% endif %}
                    </ul>
                </div>

                {% if bot_user.is_agency and bot_user.agency_link %}
                <div class="border-top pt-24 mt-8">
                    <h6 class="text-md mb-16" data-i18n="detail.agencyInviteLink">Agency Invite Link</h6>
                    <div class="bg-neutral-50 p-12 radius-8">
                        <div class="d-flex align-items-center gap-8">
                            <input type="text" class="form-control form-control-sm bg-base" id="agencyLink" value="{{ bot_user.agency_link }}" readonly>
                            <button type="button" class="btn btn-sm btn-primary-600 flex-shrink-0" onclick="copyAgencyLink()">
                                <iconify-icon icon="solar:copy-linear"></iconify-icon>
                            </button>
                        </div>
                        {% if bot_user.is_used %}
                            <span class="text-sm text-danger-600 mt-8 d-flex align-items-center">
                                <iconify-icon icon="mdi:check-circle" class="me-4"></iconify-icon>
                                <span data-i18n="detail.linkUsed">This link has been used</span>
                            </span>
                        {% else %}
                            <span class="text-sm text-success-600 mt-8 d-flex align-items-center">
                                <iconify-icon icon="mdi:link" class="me-4"></iconify-icon>
                                <span data-i18n="detail.linkActive">Link is active</span>
                            </span>
                        {% endif %}
                    </div>
                </div>
                {% endif %}

                <div class="d-flex gap-8 mt-24">
                    <a href="{% url 'usersList' %}" class="btn btn-outline-secondary-600 radius-8 px-20 py-11 flex-grow-1 d-flex align-items-center justify-content-center">
                        <iconify-icon icon="ep:back" class="me-4"></iconify-icon>
                        <span data-i18n="form.backToList">Back to List</span>
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Right Column -->
    <div class="col-lg-8">
        <!-- Stats Cards -->
        <div class="row gy-4 mb-24">
            <div class="col-sm-4">
                <div class="card radius-16 h-100">
                    <div class="card-body p-24">
                        <div class="d-flex align-items-center gap-16">
                            <div class="w-60-px h-60-px rounded-circle bg-primary-100 d-flex align-items-center justify-content-center">
                                <iconify-icon icon="solar:bag-4-linear" class="text-primary-600 text-2xl"></iconify-icon>
                            </div>
                            <div>
                                <span class="text-secondary-light text-sm d-block mb-4" data-i18n="detail.totalOrders">Total Orders</span>
                                <h4 class="mb-0">{{ total_orders }}</h4>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-sm-4">
                <div class="card radius-16 h-100">
                    <div class="card-body p-24">
                        <div class="d-flex align-items-center gap-16">
                            <div class="w-60-px h-60-px rounded-circle bg-success-100 d-flex align-items-center justify-content-center">
                                <iconify-icon icon="solar:check-circle-linear" class="text-success-600 text-2xl"></iconify-icon>
                            </div>
                            <div>
                                <span class="text-secondary-light text-sm d-block mb-4" data-i18n="status.completed">Completed</span>
                                <h4 class="mb-0">{{ completed_orders }}</h4>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-sm-4">
                <div class="card radius-16 h-100">
                    <div class="card-body p-24">
                        <div class="d-flex align-items-center gap-16">
                            <div class="w-60-px h-60-px rounded-circle bg-warning-100 d-flex align-items-center justify-content-center">
                                <iconify-icon icon="solar:clock-circle-linear" class="text-warning-600 text-2xl"></iconify-icon>
                            </div>
                            <div>
                                <span class="text-secondary-light text-sm d-block mb-4" data-i18n="detail.inProgress">In Progress</span>
                                <h4 class="mb-0">{{ pending_orders }}</h4>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Orders -->
        <div class="card radius-16">
            <div class="card-header bg-base border-bottom py-16 px-24 d-flex align-items-center justify-content-between">
                <h6 class="mb-0" data-i18n="detail.recentOrders">Recent Orders</h6>
                {% if total_orders > 0 %}
                <a href="{% url 'orders:ordersList' %}?search={{ bot_user.name }}" class="text-primary-600 text-sm fw-medium">
                    <span data-i18n="detail.viewAll">View All</span> <iconify-icon icon="ep:arrow-right" class="ms-4"></iconify-icon>
                </a>
                {% endif %}
            </div>
            <div class="card-body p-0">
                {% if orders %}
                <div class="table-responsive">
                    <table class="table bordered-table sm-table mb-0">
                        <thead>
                            <tr>
                                <th scope="col" data-i18n="table.orderId">Order ID</th>
                                {% if user.is_superuser %}
                                <th scope="col" data-i18n="table.center">Center</th>
                                {% endif %}
                                {% if user.is_superuser or is_owner %}
                                <th scope="col" data-i18n="table.branch">Branch</th>
                                {% endif %}
                                <th scope="col" data-i18n="table.product">Product</th>
                                <th scope="col" data-i18n="common.pages">Pages</th>
                                <th scope="col" data-i18n="table.status">Status</th>
                                <th scope="col" data-i18n="table.date">Date</th>
                                <th scope="col" class="text-center" data-i18n="table.action">Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for order in orders %}
                            <tr>
                                <td>
                                    <span class="fw-medium">#{{ order.id }}</span>
                                </td>
                                {% if user.is_superuser %}
                                <td>
                                    <span class="text-md fw-medium text-primary-light">{{ order.branch.center.name }}</span>
                                </td>
                                {% endif %}
                                {% if user.is_superuser or is_owner %}
                                <td>
                                    <span class="text-md fw-medium text-secondary-light">{{ order.branch.name }}</span>
                                </td>
                                {% endif %}
                                <td>{{ order.product.title }}</td>
                                <td>{{ order.total_pages }}</td>
                                <td>
                                    {% if order.status == 'pending' %}
                                        <span class="badge bg-warning-focus text-warning-600" data-i18n="status.pending">Pending</span>
                                    {% elif order.status == 'payment_pending' %}
                                        <span class="badge bg-info-focus text-info-600" data-i18n="status.paymentPending">Awaiting</span>
                                    {% elif order.status == 'payment_received' %}
                                        <span class="badge bg-primary-focus text-primary-600" data-i18n="status.paymentReceived">Received</span>
                                    {% elif order.status == 'payment_confirmed' %}
                                        <span class="badge bg-success-focus text-success-600" data-i18n="status.paymentConfirmed">Confirmed</span>
                                    {% elif order.status == 'in_progress' %}
                                        <span class="badge bg-info-focus text-info-600" data-i18n="status.inProgress">In Process</span>
                                    {% elif order.status == 'ready' %}
                                        <span class="badge bg-primary-focus text-primary-600" data-i18n="status.ready">Ready</span>
                                    {% elif order.status == 'completed' %}
                                        <span class="badge bg-success-focus text-success-600" data-i18n="status.completed">Done</span>
                                    {% elif order.status == 'cancelled' %}
                                        <span class="badge bg-danger-focus text-danger-600" data-i18n="status.cancelled">Cancelled</span>
                                    {% else %}
                                        <span class="badge bg-neutral-200 text-neutral-600">{{ order.status }}</span>
                                    {% endif %}
                                </td>
                                <td>{{ order.created_at|date:"d M Y" }}</td>
                                <td class="text-center">
                                    <a href="{% url 'orders:orderDetail' order.id %}" class="bg-info-focus bg-hover-info-200 text-info-600 fw-medium w-36-px h-36-px d-inline-flex justify-content-center align-items-center rounded-circle">
                                        <iconify-icon icon="majesticons:eye-line" class="icon text-lg"></iconify-icon>
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-40">
                    <iconify-icon icon="solar:bag-cross-linear" class="text-4xl text-secondary-light mb-8"></iconify-icon>
                    <p class="text-secondary-light mb-0" data-i18n="detail.noOrdersFound">No orders found for this user</p>
                </div>
                {% endif %}
            </div>
        </div>

        {% if bot_user.is_agency and agency_users %}
        <!-- Agency Users -->
        <div class="card radius-16 mt-24">
            <div class="card-header bg-base border-bottom py-16 px-24 d-flex align-items-center justify-content-between">
                <h6 class="mb-0 d-flex align-items-center">
                    <iconify-icon icon="mdi:account-group" class="me-8 text-warning-600"></iconify-icon>
                    <span data-i18n="detail.referredUsers">Referred Users</span> ({{ agency_users_count }})
                </h6>
                {% if agency_users_count > 5 %}
                <a href="{% url 'usersList' %}?status=agency" class="text-primary-600 text-sm fw-medium d-flex align-items-center">
                    <span data-i18n="detail.viewAll">View All</span> <iconify-icon icon="ep:arrow-right" class="ms-4"></iconify-icon>
                </a>
                {% endif %}
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table bordered-table sm-table mb-0">
                        <thead>
                            <tr>
                                <th scope="col" data-i18n="table.name">Name</th>
                                <th scope="col" data-i18n="detail.phone">Phone</th>
                                <th scope="col" data-i18n="table.status">Status</th>
                                <th scope="col" data-i18n="detail.joinedDate">Joined</th>
                                <th scope="col" class="text-center" data-i18n="table.action">Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for agency_user in agency_users %}
                            <tr>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <div class="w-32-px h-32-px rounded-circle bg-primary-100 d-flex align-items-center justify-content-center flex-shrink-0 me-8">
                                            <span class="text-primary-600 fw-semibold text-sm">{{ agency_user.name|slice:":1"|upper }}</span>
                                        </div>
                                        <span>{{ agency_user.name }}</span>
                                    </div>
                                </td>
                                <td>{{ agency_user.phone }}</td>
                                <td>
                                    {% if agency_user.is_active %}
                                        <span class="badge bg-success-focus text-success-600" data-i18n="common.active">Active</span>
                                    {% else %}
                                        <span class="badge bg-neutral-200 text-neutral-600" data-i18n="common.inactive">Inactive</span>
                                    {% endif %}
                                </td>
                                <td>{{ agency_user.created_at|date:"d M Y" }}</td>
                                <td class="text-center">
                                    <a href="{% url 'userDetail' %}?id={{ agency_user.id }}" class="bg-info-focus bg-hover-info-200 text-info-600 fw-medium w-36-px h-36-px d-inline-flex justify-content-center align-items-center rounded-circle">
                                        <iconify-icon icon="majesticons:eye-line" class="icon text-lg"></iconify-icon>
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock content %}

{% block script %}
<script>
    function copyAgencyLink() {
        var linkInput = document.getElementById('agencyLink');
        linkInput.select();
        linkInput.setSelectionRange(0, 99999);
        navigator.clipboard.writeText(linkInput.value);
        
        // Show feedback
        var btn = event.target.closest('button');
        var originalHtml = btn.innerHTML;
        btn.innerHTML = '<iconify-icon icon="solar:check-linear"></iconify-icon>';
        btn.classList.remove('btn-primary-600');
        btn.classList.add('btn-success-600');
        
        setTimeout(function() {
            btn.innerHTML = originalHtml;
            btn.classList.remove('btn-success-600');
            btn.classList.add('btn-primary-600');
        }, 2000);
    }
</script>
{% endblock %}

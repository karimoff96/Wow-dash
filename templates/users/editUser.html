{% extends '../layout/layout.html' %}
{% load static %}

{% block content %}
<div class="card h-100 p-0 radius-12">
    <div class="card-header border-bottom bg-base py-16 px-24">
        <div class="d-flex align-items-center justify-content-between">
            <h6 class="mb-0 d-flex align-items-center">
                <iconify-icon icon="lucide:edit" class="me-8 text-warning-600"></iconify-icon>
                <span data-i18n="form.editUser">Edit User</span>: {{ user.name }}
            </h6>
            <a href="{% url 'usersList' %}" class="btn btn-outline-secondary-600 radius-8 px-20 py-9 d-flex align-items-center">
                <iconify-icon icon="ep:back" class="me-4"></iconify-icon>
                <span data-i18n="form.backToList">Back to List</span>
            </a>
        </div>
    </div>
    <div class="card-body p-24">
        <div class="row justify-content-center">
            <div class="col-xxl-6 col-xl-8 col-lg-10">
                <form method="post" action="{% url 'editUser' user.id %}">
                    {% csrf_token %}
                    
                    <!-- Basic Info Section -->
                    <div class="mb-24">
                        <h6 class="text-md fw-semibold text-primary-light mb-16 d-flex align-items-center">
                            <iconify-icon icon="solar:user-linear" class="me-8"></iconify-icon>
                            <span data-i18n="form.basicInformation">Basic Information</span>
                        </h6>
                        <div class="row">
                            <div class="col-md-6 mb-20">
                                <label for="name" class="form-label fw-semibold text-primary-light text-sm mb-8">
                                    <span data-i18n="form.fullName">Full Name</span> <span class="text-danger-600">*</span>
                                </label>
                                <input type="text" class="form-control radius-8" id="name" name="name" 
                                       data-i18n-placeholder="form.enterFullName" placeholder="Enter full name" value="{{ user.name }}" required>
                            </div>
                            <div class="col-md-6 mb-20">
                                <label for="phone" class="form-label fw-semibold text-primary-light text-sm mb-8">
                                    <span data-i18n="form.phoneNumber">Phone Number</span> <span class="text-danger-600">*</span>
                                </label>
                                <input type="tel" class="form-control radius-8" id="phone" name="phone" 
                                       placeholder="+998 90 123 45 67" value="{{ user.phone }}" required>
                            </div>
                        </div>
                    </div>

                    <!-- Telegram Info Section -->
                    <div class="mb-24">
                        <h6 class="text-md fw-semibold text-primary-light mb-16 d-flex align-items-center">
                            <iconify-icon icon="ic:outline-telegram" class="me-8"></iconify-icon>
                            <span data-i18n="form.telegramInfo">Telegram Information</span>
                        </h6>
                        <div class="row">
                            <div class="col-md-6 mb-20">
                                <label for="username" class="form-label fw-semibold text-primary-light text-sm mb-8" data-i18n="form.username">
                                    Username
                                </label>
                                <div class="input-group">
                                    <span class="input-group-text bg-neutral-100">@</span>
                                    <input type="text" class="form-control radius-8" id="username" name="username" 
                                           placeholder="telegram_username" value="{{ user.username|default:'' }}">
                                </div>
                                <small class="text-secondary-light" data-i18n="form.usernameHint">Optional - Telegram username without @</small>
                            </div>
                            <div class="col-md-6 mb-20">
                                <label for="user_id" class="form-label fw-semibold text-primary-light text-sm mb-8" data-i18n="form.telegramUserId">
                                    Telegram User ID
                                </label>
                                <input type="number" class="form-control radius-8" id="user_id" name="user_id" 
                                       placeholder="123456789" value="{{ user.user_id|default:'' }}">
                                <small class="text-secondary-light" data-i18n="form.telegramUserIdHint">Optional - Numeric Telegram ID</small>
                            </div>
                        </div>
                    </div>

                    <!-- Settings Section -->
                    <div class="mb-24">
                        <h6 class="text-md fw-semibold text-primary-light mb-16 d-flex align-items-center">
                            <iconify-icon icon="solar:settings-linear" class="me-8"></iconify-icon>
                            <span data-i18n="form.settings">Settings</span>
                        </h6>
                        <div class="row">
                            <div class="col-md-6 mb-20">
                                <label for="center" class="form-label fw-semibold text-primary-light text-sm mb-8">
                                    <span data-i18n="form.center">Center</span>
                                </label>
                                <select class="form-control radius-8 form-select" id="center" name="center">
                                    <option value="" data-i18n="form.selectCenter">-- Select Center --</option>
                                    {% for center in centers %}
                                    <option value="{{ center.id }}" {% if user.center_id == center.id %}selected{% endif %}>{{ center.name }}</option>
                                    {% endfor %}
                                </select>
                                <small class="text-secondary-light" data-i18n="form.centerHint">Translation center this user belongs to</small>
                            </div>
                            <div class="col-md-6 mb-20">
                                <label for="branch" class="form-label fw-semibold text-primary-light text-sm mb-8">
                                    <span data-i18n="form.branch">Branch</span>
                                </label>
                                <select class="form-control radius-8 form-select" id="branch" name="branch">
                                    <option value="" data-i18n="form.selectBranch">-- Select Branch --</option>
                                    {% for branch in branches %}
                                    <option value="{{ branch.id }}" data-center="{{ branch.center_id }}" {% if user.branch_id == branch.id %}selected{% endif %}>
                                        {{ branch.center.name }} - {{ branch.name }}
                                    </option>
                                    {% endfor %}
                                </select>
                                <small class="text-secondary-light" data-i18n="form.branchHint">Specific branch for this user</small>
                            </div>
                            <div class="col-md-6 mb-20">
                                <label for="language" class="form-label fw-semibold text-primary-light text-sm mb-8">
                                    <span data-i18n="form.language">Language</span> <span class="text-danger-600">*</span>
                                </label>
                                <select class="form-control radius-8 form-select" id="language" name="language">
                                    {% for code, name in languages %}
                                    <option value="{{ code }}" {% if code == user.language %}selected{% endif %}>
                                        {% if code == 'uz' %}ðŸ‡ºðŸ‡¿{% elif code == 'ru' %}ðŸ‡·ðŸ‡º{% elif code == 'en' %}ðŸ‡¬ðŸ‡§{% endif %} {{ name }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-6 mb-20">
                                <label for="agency" class="form-label fw-semibold text-primary-light text-sm mb-8" data-i18n="form.agency">
                                    Agency
                                </label>
                                <select class="form-control radius-8 form-select" id="agency" name="agency">
                                    <option value="" data-i18n="form.noAgency">No Agency (Direct User)</option>
                                    {% for agency in agencies %}
                                    <option value="{{ agency.id }}" {% if user.agency_id == agency.id %}selected{% endif %}>{{ agency.name }}</option>
                                    {% endfor %}
                                </select>
                                <small class="text-secondary-light" data-i18n="form.agencyHint">Select if user was referred by an agency</small>
                            </div>
                        </div>
                    </div>

                    <!-- Status Section -->
                    <div class="mb-24">
                        <h6 class="text-md fw-semibold text-primary-light mb-16 d-flex align-items-center">
                            <iconify-icon icon="solar:shield-check-linear" class="me-8"></iconify-icon>
                            <span data-i18n="form.statusPermissions">Status & Permissions</span>
                        </h6>
                        <div class="row">
                            <div class="col-md-6 mb-20">
                                <div class="form-switch switch-primary py-12 px-16 border radius-8 position-relative">
                                    <label for="is_active" class="position-absolute w-100 h-100 start-0 top-0 cursor-pointer"></label>
                                    <div class="d-flex align-items-center gap-3 justify-content-between">
                                        <div>
                                            <span class="form-check-label line-height-1 fw-medium text-secondary-light" data-i18n="form.activeStatus">Active Status</span>
                                            <small class="d-block text-secondary-light mt-4" data-i18n="form.userCanAccessBot">User can access the bot</small>
                                        </div>
                                        <input class="form-check-input" type="checkbox" role="switch" id="is_active" name="is_active" {% if user.is_active %}checked{% endif %}>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6 mb-20">
                                <div class="form-switch switch-warning py-12 px-16 border radius-8 position-relative">
                                    <label for="is_agency" class="position-absolute w-100 h-100 start-0 top-0 cursor-pointer"></label>
                                    <div class="d-flex align-items-center gap-3 justify-content-between">
                                        <div>
                                            <span class="form-check-label line-height-1 fw-medium text-secondary-light" data-i18n="form.agencyAccount">Agency Account</span>
                                            <small class="d-block text-secondary-light mt-4" data-i18n="form.canReferUsers">Can refer other users</small>
                                        </div>
                                        <input class="form-check-input" type="checkbox" role="switch" id="is_agency" name="is_agency" {% if user.is_agency %}checked{% endif %}>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="d-flex align-items-center justify-content-center gap-3 mt-24">
                        <a href="{% url 'usersList' %}" class="border border-danger-600 bg-hover-danger-200 text-danger-600 text-md px-40 py-11 radius-8" data-i18n="common.cancel">
                            Cancel
                        </a>
                        <button type="submit" class="btn btn-primary border border-primary-600 text-md px-40 py-12 radius-8 d-flex align-items-center gap-2">
                            <iconify-icon icon="mdi:content-save" class="text-xl line-height-1"></iconify-icon>
                            <span data-i18n="form.updateUser">Update User</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock content %}

{% block script %}
<script>
    // Store all branch options for filtering
    const allBranchOptions = [];
    $('#branch option').each(function() {
        if ($(this).val()) {
            allBranchOptions.push({
                value: $(this).val(),
                text: $(this).text(),
                centerId: $(this).data('center'),
                selected: $(this).is(':selected')
            });
        }
    });
    
    // Filter branches when center changes
    $('#center').on('change', function() {
        const centerId = $(this).val();
        const $branchSelect = $('#branch');
        const currentBranchId = $branchSelect.val();
        
        // Clear and rebuild branch options
        $branchSelect.find('option:not(:first)').remove();
        
        if (centerId) {
            // Filter branches for selected center
            allBranchOptions.forEach(function(opt) {
                if (opt.centerId == centerId) {
                    const $option = $('<option>', {
                        value: opt.value,
                        text: opt.text,
                        'data-center': opt.centerId
                    });
                    if (opt.value == currentBranchId) {
                        $option.prop('selected', true);
                    }
                    $branchSelect.append($option);
                }
            });
        } else {
            // Show all branches
            allBranchOptions.forEach(function(opt) {
                const $option = $('<option>', {
                    value: opt.value,
                    text: opt.text,
                    'data-center': opt.centerId
                });
                if (opt.value == currentBranchId) {
                    $option.prop('selected', true);
                }
                $branchSelect.append($option);
            });
        }
    });
    
    // Auto-select center when branch is selected
    $('#branch').on('change', function() {
        const centerId = $(this).find(':selected').data('center');
        if (centerId) {
            $('#center').val(centerId);
        }
    });
    
    // Agency field dependency on is_agency checkbox
    $('#is_agency').on('change', function() {
        if ($(this).is(':checked')) {
            $('#agency').val('').prop('disabled', true);
        } else {
            $('#agency').prop('disabled', false);
        }
    });
    
    // Trigger on page load
    if ($('#is_agency').is(':checked')) {
        $('#agency').prop('disabled', true);
    }
    
    // Filter branches on page load if center is selected
    const initialCenter = $('#center').val();
    if (initialCenter) {
        $('#center').trigger('change');
        // Re-select the current branch
        {% if user.branch_id %}
        $('#branch').val('{{ user.branch_id }}');
        {% endif %}
    }
</script>
{% endblock %}

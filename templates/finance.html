{% extends './layout/layout.html' %} 

{% block content %}
<!-- Filter Bar -->
<div class="card radius-8 border-0 mb-24">
    <div class="card-body p-16">
        <form method="GET" class="d-flex align-items-center gap-3">
            <span class="text-md fw-semibold text-secondary-light" data-i18n="filter.defaultPeriod">Default Period:</span>
            <select name="period" id="mainPeriodSelect" class="form-select form-select-sm w-auto">
                <option value="today" {% if period == 'today' %}selected{% endif %} data-i18n="filter.today">Today</option>
                <option value="week" {% if period == 'week' %}selected{% endif %} data-i18n="filter.thisWeek">This Week</option>
                <option value="month" {% if period == 'month' %}selected{% endif %} data-i18n="filter.thisMonth">This Month</option>
                <option value="year" {% if period == 'year' %}selected{% endif %} data-i18n="filter.thisYear">This Year</option>
                <option value="custom" {% if period == 'custom' %}selected{% endif %} data-i18n="filter.custom">Custom Range</option>
            </select>
            <div id="customDateRange" class="d-flex gap-2" style="{% if period != 'custom' %}display: none;{% endif %}">
                <input type="date" name="date_from" class="form-control form-control-sm" value="{{ date_from }}" style="width: 150px;">
                <input type="date" name="date_to" class="form-control form-control-sm" value="{{ date_to }}" style="width: 150px;">
            </div>
            <button type="submit" class="btn btn-primary btn-sm px-16 d-inline-flex align-items-center gap-2">
                <iconify-icon icon="solar:filter-bold" class="icon"></iconify-icon>
                <span data-i18n="common.apply">Apply</span>
            </button>
            {% if period_label %}
            <span class="badge bg-primary-light text-primary-main px-12 py-6">
                <iconify-icon icon="solar:calendar-bold" class="me-1"></iconify-icon>
                {{ period_label }}
            </span>
            {% endif %}
        </form>
    </div>
</div>

<div class="row gy-4">
    <!-- Row 1: Quick Stats Cards -->
    <div class="col-xxl-3 col-sm-6">
        <div class="card p-3 shadow-2 radius-8 border input-form-light h-100 bg-gradient-end-1">
            <div class="card-body p-0">
                <div class="d-flex flex-wrap align-items-center justify-content-between gap-1 mb-8">
                    <div class="d-flex align-items-center gap-2">
                        <span class="mb-0 w-48-px h-48-px bg-primary-600 flex-shrink-0 text-white d-flex justify-content-center align-items-center rounded-circle h6">
                            <iconify-icon icon="solar:wallet-money-bold" class="icon"></iconify-icon>
                        </span>
                        <div>
                            <span class="mb-2 fw-medium text-secondary-light text-sm" data-i18n="finance.totalRevenue">Total Revenue</span>
                            <h6 class="fw-semibold" id="totalRevenue">{{ yearly_stats.revenue|floatformat:0 }} <small class="text-xs fw-normal">UZS</small></h6>
                        </div>
                    </div>
                </div>
                <p class="text-sm mb-0">
                    {% if monthly_revenue_change >= 0 %}
                    <span class="bg-success-focus px-1 rounded-2 fw-medium text-success-main text-sm">+{{ monthly_revenue_change }}%</span>
                    {% else %}
                    <span class="bg-danger-focus px-1 rounded-2 fw-medium text-danger-main text-sm">{{ monthly_revenue_change }}%</span>
                    {% endif %}
                    <span class="text-secondary-light" data-i18n="finance.vsLastMonth">vs last month</span>
                </p>
            </div>
        </div>
    </div>

    <div class="col-xxl-3 col-sm-6">
        <div class="card p-3 shadow-2 radius-8 border input-form-light h-100 bg-gradient-end-2">
            <div class="card-body p-0">
                <div class="d-flex flex-wrap align-items-center justify-content-between gap-1 mb-8">
                    <div class="d-flex align-items-center gap-2">
                        <span class="mb-0 w-48-px h-48-px bg-success-main flex-shrink-0 text-white d-flex justify-content-center align-items-center rounded-circle h6">
                            <iconify-icon icon="solar:bag-4-bold" class="icon"></iconify-icon>
                        </span>
                        <div>
                            <span class="mb-2 fw-medium text-secondary-light text-sm" data-i18n="sales.totalOrders">Total Orders</span>
                            <h6 class="fw-semibold" id="totalOrders">{{ yearly_stats.count }}</h6>
                        </div>
                    </div>
                </div>
                <p class="text-sm mb-0"><span class="text-secondary-light"><span id="totalPages" class="fw-semibold text-primary-light">{{ yearly_stats.pages }}</span> <span data-i18n="finance.pages">pages</span></span></p>
            </div>
        </div>
    </div>

    <div class="col-xxl-3 col-sm-6">
        <div class="card p-3 shadow-2 radius-8 border input-form-light h-100 bg-gradient-end-3">
            <div class="card-body p-0">
                <div class="d-flex flex-wrap align-items-center justify-content-between gap-1 mb-8">
                    <div class="d-flex align-items-center gap-2">
                        <span class="mb-0 w-48-px h-48-px bg-yellow text-white flex-shrink-0 d-flex justify-content-center align-items-center rounded-circle h6">
                            <iconify-icon icon="solar:chart-2-bold" class="icon"></iconify-icon>
                        </span>
                        <div>
                            <span class="mb-2 fw-medium text-secondary-light text-sm" data-i18n="finance.avgOrderValue">Avg Order Value</span>
                            <h6 class="fw-semibold" id="avgOrderValue">{{ yearly_stats.avg_order_value|floatformat:0 }} <small class="text-xs fw-normal">UZS</small></h6>
                        </div>
                    </div>
                </div>
                <p class="text-sm mb-0"><span class="text-secondary-light" data-i18n="finance.perOrderAverage">Per order average</span></p>
            </div>
        </div>
    </div>

    <div class="col-xxl-3 col-sm-6">
        <div class="card p-3 shadow-2 radius-8 border input-form-light h-100 bg-gradient-end-4">
            <div class="card-body p-0">
                <div class="d-flex flex-wrap align-items-center justify-content-between gap-1 mb-8">
                    <div class="d-flex align-items-center gap-2">
                        <span class="mb-0 w-48-px h-48-px bg-warning-main text-white flex-shrink-0 d-flex justify-content-center align-items-center rounded-circle h6">
                            <iconify-icon icon="solar:clock-circle-bold" class="icon"></iconify-icon>
                        </span>
                        <div>
                            <span class="mb-2 fw-medium text-secondary-light text-sm" data-i18n="finance.pendingPayments">Pending Payments</span>
                            <h6 class="fw-semibold">{{ pending_payments_total|floatformat:0 }} <small class="text-xs fw-normal">UZS</small></h6>
                        </div>
                    </div>
                </div>
                <p class="text-sm mb-0"><span class="bg-warning-focus px-1 rounded-2 fw-medium text-warning-main text-sm">{{ pending_payments_count }}</span> <span class="text-secondary-light" data-i18n="finance.awaiting">awaiting</span></p>
            </div>
        </div>
    </div>

    <!-- Revenue Trend Chart -->
    <div class="col-xxl-8">
        <div class="card h-100 radius-8 border">
            <div class="card-body p-24">
                <div class="d-flex align-items-center flex-wrap gap-2 justify-content-between">
                    <div>
                        <h6 class="mb-2 fw-bold text-lg" data-i18n="finance.revenueTrend">Revenue Trend</h6>
                        <span class="text-sm fw-medium text-secondary-light" data-i18n="finance.last12Months">Last 12 months</span>
                    </div>
                </div>
                <div id="revenueChart" class="mt-28"></div>
            </div>
        </div>
    </div>

    <!-- Payment Methods -->
    <div class="col-xxl-4">
        <div class="card h-100 radius-8 border">
            <div class="card-body p-24">
                <div class="d-flex align-items-center flex-wrap gap-2 justify-content-between">
                    <h6 class="mb-2 fw-bold text-lg" data-i18n="finance.paymentMethods">Payment Methods</h6>
                    <select class="form-select form-select-sm w-auto bg-base border text-secondary-light radius-8" id="paymentPeriodSelect">
                        <option value="yearly" selected data-i18n="common.yearly">Yearly</option>
                        <option value="monthly" data-i18n="common.monthly">Monthly</option>
                        <option value="weekly" data-i18n="common.weekly">Weekly</option>
                        <option value="today" data-i18n="common.today">Today</option>
                    </select>
                </div>
                <div id="paymentDonutChart" class="mt-16"></div>
                <div class="mt-20 d-flex flex-column gap-12">
                    <div class="d-flex align-items-center justify-content-between p-12 radius-8 bg-success-focus">
                        <div class="d-flex align-items-center gap-2">
                            <iconify-icon icon="solar:cash-out-bold" class="text-success-main text-xl"></iconify-icon>
                            <span class="text-primary-light text-sm fw-medium" data-i18n="finance.cash">Cash</span>
                        </div>
                        <div class="text-end">
                            <span class="fw-bold text-success-main" id="cashRevenue">0 UZS</span>
                            <span class="text-secondary-light text-xs d-block" id="cashCount">(0 <span data-i18n="sidebar.orders">orders</span>)</span>
                        </div>
                    </div>
                    <div class="d-flex align-items-center justify-content-between p-12 radius-8 bg-primary-focus">
                        <div class="d-flex align-items-center gap-2">
                            <iconify-icon icon="solar:card-bold" class="text-primary-600 text-xl"></iconify-icon>
                            <span class="text-primary-light text-sm fw-medium" data-i18n="finance.card">Card</span>
                        </div>
                        <div class="text-end">
                            <span class="fw-bold text-primary-600" id="cardRevenue">0 UZS</span>
                            <span class="text-secondary-light text-xs d-block" id="cardCount">(0 <span data-i18n="sidebar.orders">orders</span>)</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Revenue by User Type -->
    <div class="col-xxl-4">
        <div class="card h-100 radius-8 border">
            <div class="card-body p-24">
                <div class="d-flex align-items-center flex-wrap gap-2 justify-content-between">
                    <h6 class="mb-2 fw-bold text-lg" data-i18n="finance.revenueByUserType">Revenue by User Type</h6>
                    <select class="form-select form-select-sm w-auto bg-base border text-secondary-light radius-8" id="userTypePeriodSelect">
                        <option value="yearly" selected data-i18n="common.yearly">Yearly</option>
                        <option value="monthly" data-i18n="common.monthly">Monthly</option>
                        <option value="weekly" data-i18n="common.weekly">Weekly</option>
                        <option value="today" data-i18n="common.today">Today</option>
                    </select>
                </div>
                <div id="userTypeDonutChart" class="mt-16"></div>
                <div class="mt-20 d-flex flex-column gap-12">
                    <div class="d-flex align-items-center justify-content-between p-12 radius-8 bg-info-focus">
                        <div class="d-flex align-items-center gap-2">
                            <iconify-icon icon="solar:buildings-2-bold" class="text-info-main text-xl"></iconify-icon>
                            <span class="text-primary-light text-sm fw-medium" data-i18n="dashboard.agencies">Agencies</span>
                        </div>
                        <div class="text-end">
                            <span class="fw-bold text-info-main" id="agencyRevenue">0 UZS</span>
                            <span class="text-secondary-light text-xs d-block" id="agencyCount">(0 <span data-i18n="sidebar.orders">orders</span>)</span>
                        </div>
                    </div>
                    <div class="d-flex align-items-center justify-content-between p-12 radius-8 bg-warning-focus">
                        <div class="d-flex align-items-center gap-2">
                            <iconify-icon icon="solar:user-bold" class="text-warning-main text-xl"></iconify-icon>
                            <span class="text-primary-light text-sm fw-medium" data-i18n="finance.regularCustomers">Regular Customers</span>
                        </div>
                        <div class="text-end">
                            <span class="fw-bold text-warning-main" id="regularRevenue">0 UZS</span>
                            <span class="text-secondary-light text-xs d-block" id="regularCount">(0 <span data-i18n="sidebar.orders">orders</span>)</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- AOV Trend Chart -->
    <div class="col-xxl-4">
        <div class="card h-100 radius-8 border">
            <div class="card-body p-24">
                <div class="d-flex align-items-center flex-wrap gap-2 justify-content-between">
                    <h6 class="mb-2 fw-bold text-lg" data-i18n="finance.avgOrderValueTrend">Avg Order Value Trend</h6>
                    <span class="text-sm fw-medium text-secondary-light px-12 py-4 bg-base radius-8" data-i18n="finance.last7Days">Last 7 days</span>
                </div>
                <div id="aovChart" class="mt-20"></div>
            </div>
        </div>
    </div>

    <!-- Top Products by Revenue -->
    <div class="col-xxl-4">
        <div class="card h-100 radius-8 border">
            <div class="card-header border-bottom bg-base py-16 px-24 d-flex align-items-center justify-content-between">
                <h6 class="text-lg fw-semibold mb-0" data-i18n="finance.topProducts">Top Products</h6>
                <select class="form-select form-select-sm w-auto bg-base border text-secondary-light radius-8" id="productPeriodSelect">
                    <option value="yearly" selected data-i18n="common.yearly">Yearly</option>
                    <option value="monthly" data-i18n="common.monthly">Monthly</option>
                    <option value="weekly" data-i18n="common.weekly">Weekly</option>
                    <option value="today" data-i18n="common.today">Today</option>
                </select>
            </div>
            <div class="card-body p-24">
                <div class="table-responsive">
                    <table class="table bordered-table mb-0">
                        <thead>
                            <tr>
                                <th scope="col" class="col-id">#</th>
                                <th scope="col" data-i18n="table.product">Product</th>
                                <th scope="col" class="text-center col-id" data-i18n="table.orders">#</th>
                                <th scope="col" class="col-amount" data-i18n="table.revenue">Revenue</th>
                            </tr>
                        </thead>
                        <tbody id="topProductsBody"></tbody>
                    </table>
                    <div id="noProductsMessage" class="text-center py-24 d-none">
                        <span class="text-secondary-light text-sm" data-i18n="table.noProductsFound">No products found</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock content %}

{% block script %}
<script>
// Main period filter toggle for custom date range
const mainPeriodSelect = document.getElementById('mainPeriodSelect');
const customDateRange = document.getElementById('customDateRange');

if (mainPeriodSelect && customDateRange) {
    mainPeriodSelect.addEventListener('change', function() {
        if (this.value === 'custom') {
            customDateRange.style.display = 'flex';
        } else {
            customDateRange.style.display = 'none';
            // Auto-submit when not custom
            this.form.submit();
        }
    });
}

const paymentBreakdownData = {{ payment_breakdown|safe }};
const userTypeRevenueData = {{ user_type_revenue|safe }};
const productRevenueData = {{ product_revenue|safe }};
const monthlyRevenueChart = {{ monthly_revenue_chart|safe }};
const monthlyRevenueLabels = {{ monthly_revenue_labels|safe }};
const aovTrendData = {{ aov_trend_data|safe }};
const aovTrendLabels = {{ aov_trend_labels|safe }};

function formatNumber(num) { return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ","); }
function formatShort(num) {
    num = parseFloat(num) || 0;
    if (num >= 1000000000) return (num / 1000000000).toFixed(1) + 'B';
    if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
    if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
    return num.toFixed(0);
}
function getThemeColors() {
    const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
    return { textColor: isDark ? '#9CA3AF' : '#6C757D', gridColor: isDark ? '#374151' : '#E4E7EC', bgColor: isDark ? '#1F2937' : '#ffffff' };
}

// Revenue Chart
function initRevenueChart() {
    const colors = getThemeColors();
    new ApexCharts(document.querySelector("#revenueChart"), {
        series: [{ name: 'Revenue', data: monthlyRevenueChart }],
        chart: { type: 'area', height: 250, toolbar: { show: false } },
        colors: ['#487FFF'],
        fill: { type: 'gradient', gradient: { shadeIntensity: 1, opacityFrom: 0.4, opacityTo: 0.1 } },
        stroke: { curve: 'smooth', width: 2 },
        dataLabels: { enabled: false },
        xaxis: { categories: monthlyRevenueLabels, labels: { style: { colors: colors.textColor, fontSize: '12px' } }, axisBorder: { show: false }, axisTicks: { show: false } },
        yaxis: { labels: { formatter: val => val >= 1000000 ? (val/1000000).toFixed(1)+'M' : val >= 1000 ? (val/1000).toFixed(0)+'K' : val, style: { colors: colors.textColor, fontSize: '12px' } } },
        grid: { borderColor: colors.gridColor, strokeDashArray: 3 },
        tooltip: { y: { formatter: val => formatNumber(val) + ' UZS' } }
    }).render();
}

// Payment Donut Chart
let paymentDonutChart;
function updatePaymentChart(period) {
    const data = paymentBreakdownData[period];
    document.getElementById('cashRevenue').textContent = formatNumber(data.cash.revenue) + ' UZS';
    document.getElementById('cashCount').textContent = '(' + data.cash.count + ' orders)';
    document.getElementById('cardRevenue').textContent = formatNumber(data.card.revenue) + ' UZS';
    document.getElementById('cardCount').textContent = '(' + data.card.count + ' orders)';
    if (paymentDonutChart) paymentDonutChart.updateSeries([data.cash.revenue, data.card.revenue]);
}
function initPaymentDonutChart() {
    const colors = getThemeColors();
    const data = paymentBreakdownData.yearly;
    paymentDonutChart = new ApexCharts(document.querySelector("#paymentDonutChart"), {
        series: [data.cash.revenue, data.card.revenue],
        chart: { type: 'donut', height: 180 },
        labels: ['Cash', 'Card'],
        colors: ['#45B369', '#487FFF'],
        legend: { show: false },
        dataLabels: { enabled: false },
        plotOptions: { pie: { donut: { size: '70%', labels: { show: true, name: { show: true, fontSize: '12px', color: colors.textColor }, value: { show: true, fontSize: '14px', fontWeight: 600, color: colors.textColor, formatter: val => formatShort(val) }, total: { show: true, label: 'Total', color: colors.textColor, formatter: w => formatShort(w.globals.seriesTotals.reduce((a,b) => a+b, 0)) } } } } }
    });
    paymentDonutChart.render();
    updatePaymentChart('yearly');
}

// User Type Donut Chart
let userTypeDonutChart;
function updateUserTypeChart(period) {
    const data = userTypeRevenueData[period];
    document.getElementById('agencyRevenue').textContent = formatNumber(data.agency.revenue) + ' UZS';
    document.getElementById('agencyCount').textContent = '(' + data.agency.count + ' orders)';
    document.getElementById('regularRevenue').textContent = formatNumber(data.regular.revenue) + ' UZS';
    document.getElementById('regularCount').textContent = '(' + data.regular.count + ' orders)';
    if (userTypeDonutChart) userTypeDonutChart.updateSeries([data.agency.revenue, data.regular.revenue]);
}
function initUserTypeDonutChart() {
    const colors = getThemeColors();
    const data = userTypeRevenueData.yearly;
    userTypeDonutChart = new ApexCharts(document.querySelector("#userTypeDonutChart"), {
        series: [data.agency.revenue, data.regular.revenue],
        chart: { type: 'donut', height: 180 },
        labels: ['Agencies', 'Regular'],
        colors: ['#06B6D4', '#F59E0B'],
        legend: { show: false },
        dataLabels: { enabled: false },
        plotOptions: { pie: { donut: { size: '70%', labels: { show: true, name: { show: true, fontSize: '12px', color: colors.textColor }, value: { show: true, fontSize: '14px', fontWeight: 600, color: colors.textColor, formatter: val => formatShort(val) }, total: { show: true, label: 'Total', color: colors.textColor, formatter: w => formatShort(w.globals.seriesTotals.reduce((a,b) => a+b, 0)) } } } } }
    });
    userTypeDonutChart.render();
    updateUserTypeChart('yearly');
}

// AOV Chart
function initAovChart() {
    const colors = getThemeColors();
    new ApexCharts(document.querySelector("#aovChart"), {
        series: [{ name: 'AOV', data: aovTrendData }],
        chart: { type: 'bar', height: 200, toolbar: { show: false } },
        colors: ['#487FFF'],
        plotOptions: { bar: { borderRadius: 4, columnWidth: '50%' } },
        dataLabels: { enabled: false },
        xaxis: { categories: aovTrendLabels, labels: { style: { colors: colors.textColor, fontSize: '11px' } }, axisBorder: { show: false }, axisTicks: { show: false } },
        yaxis: { labels: { formatter: val => val >= 1000 ? (val/1000).toFixed(0)+'K' : val, style: { colors: colors.textColor, fontSize: '11px' } } },
        grid: { borderColor: colors.gridColor, strokeDashArray: 3 },
        tooltip: { y: { formatter: val => formatNumber(val) + ' UZS' } }
    }).render();
}

// Top Products Table
function updateProductsTable(period) {
    const products = productRevenueData[period] || [];
    const tbody = document.getElementById('topProductsBody');
    const empty = document.getElementById('noProductsMessage');
    if (!products || products.length === 0) {
        tbody.innerHTML = '';
        empty.classList.remove('d-none');
        return;
    }
    empty.classList.add('d-none');
    tbody.innerHTML = products.map((p, i) => 
        '<tr><td class="text-secondary-light">' + (i+1) + '</td>' +
        '<td><span class="text-primary-light fw-medium">' + p.name + '</span></td>' +
        '<td class="text-center"><span class="bg-success-focus text-success-main px-12 py-4 rounded-pill fw-medium text-sm">' + p.count + '</span></td>' +
        '<td class="text-secondary-light">' + formatNumber(p.revenue) + ' UZS</td></tr>'
    ).join('');
}

document.addEventListener('DOMContentLoaded', function() {
    initRevenueChart();
    initPaymentDonutChart();
    initUserTypeDonutChart();
    initAovChart();
    updateProductsTable('yearly');
    
    document.getElementById('paymentPeriodSelect').addEventListener('change', e => updatePaymentChart(e.target.value));
    document.getElementById('userTypePeriodSelect').addEventListener('change', e => updateUserTypeChart(e.target.value));
    document.getElementById('productPeriodSelect').addEventListener('change', e => updateProductsTable(e.target.value));
});
</script>
{% endblock script %}

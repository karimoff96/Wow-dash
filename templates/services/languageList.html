{% extends '../layout/layout.html' %}
{% load i18n %}
{% load number_filters %}
{% load permission_tags %}

{% block content %}
<div class="row gy-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <iconify-icon icon="mdi:translate" class="me-2"></iconify-icon>
                    Languages Management
                </h5>
                {% can_do 'languages.create' as can_create_languages %}
                {% if can_create_languages %}
                <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addLanguageModal">
                    <iconify-icon icon="mdi:plus" class="me-2"></iconify-icon>
                    Add New Language
                </button>
                {% endif %}
            </div>
            <div class="card-body">
                <!-- Search and Filter -->
                <form method="get" class="mb-20">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <input type="text" name="search" class="form-control" data-i18n-placeholder="form.searchLanguage" placeholder="Search by language name or code..." value="{{ search_query }}">
                        </div>
                        <div class="col-md-2">
                            <select name="per_page" class="form-select">
                                <option value="10" {% if per_page == 10 %}selected{% endif %}>10 per page</option>
                                <option value="20" {% if per_page == 20 %}selected{% endif %}>20 per page</option>
                                <option value="50" {% if per_page == 50 %}selected{% endif %}>50 per page</option>
                                <option value="100" {% if per_page == 100 %}selected{% endif %}>100 per page</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <div class="d-flex gap-2">
                                <button type="submit" class="btn btn-primary flex-grow-1">
                                    <iconify-icon icon="mdi:magnify"></iconify-icon> Search
                                </button>
                                <a href="{% url 'languageList' %}" class="btn btn-secondary">
                                    <iconify-icon icon="mdi:refresh"></iconify-icon> Reset
                                </a>
                            </div>
                        </div>
                    </div>
                </form>

                <!-- Languages Table -->
                <div class="table-responsive">
                    <table class="table bordered-table mb-0">
                        <thead>
                            <tr>
                                <th data-i18n="table.language">Language</th>
                                <th data-i18n="table.shortCode">Short Code</th>
                                <th class="text-center" colspan="3" data-i18n="pricing.agencyPricing">Agency Pricing (UZS)</th>
                                <th class="text-center" colspan="3" data-i18n="pricing.ordinaryPricing">Ordinary User Pricing (UZS)</th>
                                <th class="text-center" data-i18n="table.action">Actions</th>
                            </tr>
                            <tr class="bg-neutral-50">
                                <th colspan="2"></th>
                                <th class="text-center text-sm">1st Page</th>
                                <th class="text-center text-sm">Other Pages</th>
                                <th class="text-center text-sm">Copy</th>
                                <th class="text-center text-sm">1st Page</th>
                                <th class="text-center text-sm">Other Pages</th>
                                <th class="text-center text-sm">Copy</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for language in languages %}
                            <tr>
                                <td class="fw-semibold">{{ language.name }}</td>
                                <td>
                                    <span class="badge bg-primary-100 text-primary-600 px-12 py-6">{{ language.short_name }}</span>
                                </td>
                                <!-- Agency Pricing -->
                                <td class="text-end text-primary-600">{{ language.agency_page_price|format_number }}</td>
                                <td class="text-end text-primary-600">{{ language.agency_other_page_price|format_number }}</td>
                                <td class="text-end text-primary-600">{{ language.agency_copy_price|format_number }}</td>
                                <!-- Ordinary User Pricing -->
                                <td class="text-end text-success-600">{{ language.ordinary_page_price|format_number }}</td>
                                <td class="text-end text-success-600">{{ language.ordinary_other_page_price|format_number }}</td>
                                <td class="text-end text-success-600">{{ language.ordinary_copy_price|format_number }}</td>
                                <!-- Actions -->
                                <td class="text-center">
                                    {% can_do 'languages.edit' as can_edit_languages %}
                                    {% if can_edit_languages %}
                                    <a href="{% url 'editLanguage' language.id %}" class="btn btn-sm btn-outline-primary py-4 px-12">
                                        <iconify-icon icon="mdi:pencil"></iconify-icon> Edit
                                    </a>
                                    {% else %}
                                    <span class="text-secondary-light">-</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="9" class="text-center py-20">
                                    <iconify-icon icon="mdi:translate-off" class="text-secondary-light" style="font-size: 48px;"></iconify-icon>
                                    <p class="text-secondary-light mt-2 mb-0">No languages found</p>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <!-- Pagination -->
                {% if languages.has_other_pages %}
                <div class="d-flex justify-content-between align-items-center mt-20">
                    <div class="text-secondary-light">
                        Showing {{ languages.start_index }} to {{ languages.end_index }} of {{ languages.paginator.count }} languages
                    </div>
                    <nav>
                        <ul class="pagination">
                            {% if languages.has_previous %}
                            <li class="page-item">
                                <a class="page-link" href="?page=1{% if search_query %}&search={{ search_query }}{% endif %}&per_page={{ per_page }}">First</a>
                            </li>
                            <li class="page-item">
                                <a class="page-link" href="?page={{ languages.previous_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}&per_page={{ per_page }}">Previous</a>
                            </li>
                            {% endif %}

                            <li class="page-item active">
                                <span class="page-link">{{ languages.number }}</span>
                            </li>

                            {% if languages.has_next %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ languages.next_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}&per_page={{ per_page }}">Next</a>
                            </li>
                            <li class="page-item">
                                <a class="page-link" href="?page={{ languages.paginator.num_pages }}{% if search_query %}&search={{ search_query }}{% endif %}&per_page={{ per_page }}">Last</a>
                            </li>
                            {% endif %}
                        </ul>
                    </nav>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Add Language Modal -->
{% can_do 'languages.create' as can_create_languages %}
{% if can_create_languages %}
<div class="modal fade" id="addLanguageModal" tabindex="-1" aria-labelledby="addLanguageModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addLanguageModalLabel">
                    <iconify-icon icon="mdi:translate-plus" class="me-2"></iconify-icon>
                    Add New Language
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addLanguageForm">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="languageName" class="form-label fw-semibold" data-i18n="form.languageName">Language Name <span class="text-danger">*</span></label>
                        <input type="text" class="form-control radius-8" id="languageName" required data-i18n-placeholder="form.languageNamePlaceholder" placeholder="e.g., English, French, Spanish">
                    </div>
                    <div class="mb-3">
                        <label for="languageShortName" class="form-label fw-semibold" data-i18n="form.shortName">Short Name <span class="text-danger">*</span></label>
                        <input type="text" class="form-control radius-8" id="languageShortName" required data-i18n-placeholder="form.shortNamePlaceholder" placeholder="e.g., EN, FR, ES" maxlength="10">
                        <small class="text-secondary-light" data-i18n="form.shortNameHint">2-3 letter code (will be auto-capitalized)</small>
                    </div>
                    
                    <h6 class="text-md fw-semibold mt-20 mb-12 text-primary-600">
                        <iconify-icon icon="mdi:office-building" class="me-2"></iconify-icon>
                        Agency Pricing (UZS)
                    </h6>
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="agencyPagePrice" class="form-label text-sm">1st Page</label>
                            <input type="number" step="0.01" class="form-control radius-8" id="agencyPagePrice" value="0" placeholder="0">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="agencyOtherPagePrice" class="form-label text-sm">Other Pages</label>
                            <input type="number" step="0.01" class="form-control radius-8" id="agencyOtherPagePrice" value="0" placeholder="0">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="agencyCopyPrice" class="form-label text-sm">Copy Price</label>
                            <input type="number" step="0.01" class="form-control radius-8" id="agencyCopyPrice" value="0" placeholder="0">
                        </div>
                    </div>
                    
                    <h6 class="text-md fw-semibold mt-12 mb-12 text-success-600">
                        <iconify-icon icon="mdi:account" class="me-2"></iconify-icon>
                        Ordinary User Pricing (UZS)
                    </h6>
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="ordinaryPagePrice" class="form-label text-sm">1st Page</label>
                            <input type="number" step="0.01" class="form-control radius-8" id="ordinaryPagePrice" value="0" placeholder="0">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="ordinaryOtherPagePrice" class="form-label text-sm">Other Pages</label>
                            <input type="number" step="0.01" class="form-control radius-8" id="ordinaryOtherPagePrice" value="0" placeholder="0">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="ordinaryCopyPrice" class="form-label text-sm">Copy Price</label>
                            <input type="number" step="0.01" class="form-control radius-8" id="ordinaryCopyPrice" value="0" placeholder="0">
                        </div>
                    </div>
                    <div class="alert alert-info d-flex align-items-start mb-0">
                        <iconify-icon icon="mdi:information" class="me-2 mt-4" style="font-size: 20px;"></iconify-icon>
                        <small class="text-secondary-light">Pricing fields are optional. Leave as 0 if no additional cost for this language.</small>
                    </div>
                    
                    <div id="languageError" class="alert alert-danger d-none mt-12"></div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary radius-8" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary radius-8" id="saveLanguageBtn">
                    <iconify-icon icon="mdi:content-save" class="me-1"></iconify-icon>
                    Create Language
                </button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const modal = document.getElementById('addLanguageModal');
    const form = document.getElementById('addLanguageForm');
    const saveBtn = document.getElementById('saveLanguageBtn');
    const errorDiv = document.getElementById('languageError');
    const languageNameInput = document.getElementById('languageName');
    const languageShortNameInput = document.getElementById('languageShortName');
    
    if (!modal) return;
    
    // Auto-capitalize short name
    languageShortNameInput.addEventListener('input', function() {
        this.value = this.value.toUpperCase();
    });
    
    saveBtn.addEventListener('click', function() {
        const name = languageNameInput.value.trim();
        const shortName = languageShortNameInput.value.trim().toUpperCase();
        
        if (!name || !shortName) {
            errorDiv.textContent = 'Both Language Name and Short Name are required.';
            errorDiv.classList.remove('d-none');
            return;
        }
        
        // Get pricing values
        const agencyPagePrice = document.getElementById('agencyPagePrice').value || '0';
        const agencyOtherPagePrice = document.getElementById('agencyOtherPagePrice').value || '0';
        const agencyCopyPrice = document.getElementById('agencyCopyPrice').value || '0';
        const ordinaryPagePrice = document.getElementById('ordinaryPagePrice').value || '0';
        const ordinaryOtherPagePrice = document.getElementById('ordinaryOtherPagePrice').value || '0';
        const ordinaryCopyPrice = document.getElementById('ordinaryCopyPrice').value || '0';
        
        // Disable button and show loading
        saveBtn.disabled = true;
        saveBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span> Creating...';
        errorDiv.classList.add('d-none');
        
        // Send AJAX request
        fetch('{% url "createLanguageInline" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({
                name: name,
                short_name: shortName,
                agency_page_price: agencyPagePrice,
                agency_other_page_price: agencyOtherPagePrice,
                agency_copy_price: agencyCopyPrice,
                ordinary_page_price: ordinaryPagePrice,
                ordinary_other_page_price: ordinaryOtherPagePrice,
                ordinary_copy_price: ordinaryCopyPrice
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Close modal and reload page
                const modalInstance = bootstrap.Modal.getInstance(modal);
                modalInstance.hide();
                
                // Show success message
                const successAlert = document.createElement('div');
                successAlert.className = 'alert alert-success alert-dismissible fade show';
                successAlert.innerHTML = `
                    <iconify-icon icon="mdi:check-circle" class="me-2"></iconify-icon>
                    Language "${data.language.name}" created successfully!
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
                document.querySelector('.card-body').insertBefore(successAlert, document.querySelector('.card-body').firstChild);
                
                // Reload page to show new language
                setTimeout(() => window.location.reload(), 1500);
            } else {
                errorDiv.textContent = data.error || 'An error occurred while creating the language.';
                errorDiv.classList.remove('d-none');
                saveBtn.disabled = false;
                saveBtn.innerHTML = '<iconify-icon icon="mdi:content-save" class="me-1"></iconify-icon> Create Language';
            }
        })
        .catch(error => {
            errorDiv.textContent = 'Network error. Please try again.';
            errorDiv.classList.remove('d-none');
            saveBtn.disabled = false;
            saveBtn.innerHTML = '<iconify-icon icon="mdi:content-save" class="me-1"></iconify-icon> Create Language';
        });
    });
    
    // Reset form when modal is closed
    modal.addEventListener('hidden.bs.modal', function () {
        form.reset();
        errorDiv.classList.add('d-none');
        saveBtn.disabled = false;
        saveBtn.innerHTML = '<iconify-icon icon="mdi:content-save" class="me-1"></iconify-icon> Create Language';
    });
});
</script>
{% endif %}

{% endblock content %}
